<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>Dove of Hope : Sky Blessing</title>
<script src="bible-verses.js"></script>
<script src="translations.js"></script>
<script src="../js/testimonies.js"></script>
<style>
* {
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
}
body{margin:0;padding:0;background:linear-gradient(135deg,#e8eef2 0%,#d4dce3 50%,#c5d0d8 100%);font-family:Arial,sans-serif;overflow:hidden;touch-action:none;position:fixed;width:100%;height:100%}
#gameContainer{position:relative;width:100vw;height:100vh;max-width:480px;margin:0 auto;background:linear-gradient(180deg,#87ceeb 0%,#b8d8f8 100%);display:flex;align-items:center;justify-content:center}
#gameCanvas{display:block;cursor:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);max-width:100%;max-height:100%;z-index:10}
.landscape{position:absolute;bottom:0;left:0;right:0;height:100vh;background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300'%3E%3Cpolygon points='0,300 80,240 160,300' fill='%23f8f9fa' opacity='0.5'/%3E%3Cpolygon points='120,300 200,240 280,300' fill='%23ffffff' opacity='0.8'/%3E%3Cpolygon points='240,300 320,240 400,300' fill='%23f8f9fa' opacity='0.5'/%3E%3Cpolygon points='60,300 140,260 220,300' fill='%23ecf0f1' opacity='0.4'/%3E%3Cpolygon points='180,300 260,260 340,300' fill='%23ecf0f1' opacity='0.4'/%3E%3C/svg%3E") no-repeat bottom center/cover;pointer-events:none;z-index:1}
#ui{position:absolute;top:0;left:0;right:0;color:#2c3e50;font-weight:600;z-index:100;font-size:11px;background:linear-gradient(180deg,rgba(255,255,255,0.92) 0%,rgba(255,255,255,0.8) 90%,rgba(255,255,255,0) 100%);backdrop-filter:blur(10px);padding:4px 10px;box-shadow:0 1px 6px rgba(0,0,0,0.08);display:flex;justify-content:space-between;align-items:center;gap:8px}
#ui > div{display:flex;align-items:center;gap:3px;color:#34495e;white-space:nowrap}
#ui > div span{font-weight:900;color:#2c3e50;font-size:13px}
#ui .ui-section{display:flex;align-items:center;gap:8px}
#message{position:absolute;top:20%;left:50%;transform:translate(-50%,-50%);color:#000000;font-size:18px;font-weight:bold;text-align:center;opacity:0;transition:opacity 0.5s;-webkit-text-stroke:2px white;text-stroke:2px white;paint-order:stroke fill;z-index:200;max-width:90%;padding:15px;word-wrap:break-word;overflow-wrap:break-word;white-space:normal;line-height:1.4}
#startButton{position:absolute;bottom:80px;left:50%;transform:translateX(-50%);width:90px;height:110px;background:linear-gradient(180deg,transparent 0%,transparent 50%,#34495e 50%,#2c3e50 100%);border:3px solid #2c3e50;border-radius:50% 50% 50% 50%/60% 60% 40% 40%;cursor:pointer;transition:all 0.5s;overflow:visible;z-index:300;box-shadow:0 5px 15px rgba(0,0,0,0.3)}
#startButton.hidden{opacity:0;pointer-events:none;transform:translateX(-50%) scale(0.5)}
#startButton::before{content:'ğŸ’¡';position:absolute;top:40%;left:50%;transform:translate(-50%,-50%);font-size:42px;animation:bulbGlow 2s infinite;filter:drop-shadow(0 0 10px rgba(255,235,59,0.6))}
#startButton::after{content:'O/I';position:absolute;bottom:18px;left:50%;transform:translateX(-50%);color:white;font-size:14px;font-weight:bold;text-shadow:0 2px 4px rgba(0,0,0,0.8);letter-spacing:2px}
#startButton:hover,#startButton:active{transform:translateX(-50%) translateY(-8px) scale(1.05);box-shadow:0 15px 35px rgba(52,152,219,0.5),0 0 20px rgba(255,235,59,0.4)}
#startButton:hover::before,#startButton:active::before{font-size:48px;filter:drop-shadow(0 0 20px rgba(255,235,59,1))}
.sun{position:absolute;top:15%;right:50px;transform:translateY(-50%);width:60px;height:60px;border-radius:50%;transition:all 0.4s ease;z-index:5}
.sun::before{content:'';position:absolute;top:-10px;left:-10px;right:-10px;bottom:-10px;border-radius:50%;border:3px solid;opacity:0.5;animation:rays 4s infinite linear}
.sun::after{content:'';position:absolute;top:-5px;left:-5px;right:-5px;bottom:-5px;border-radius:50%;border:2px dashed;opacity:0.3;animation:rays 6s infinite linear reverse}
.sun.happy{background:radial-gradient(circle,#fff9c4 0%,#ffeb3b 40%,#ffc107 70%,#ff9800 100%);box-shadow:0 0 40px rgba(255,193,7,0.8),0 0 20px rgba(255,235,59,0.6);animation:glow 2s infinite}
.sun.happy::before{border-color:#ffc107;opacity:0.7}
.sun.happy::after{border-color:#ffeb3b}
.sun.sad{background:radial-gradient(circle,#ecf0f1 0%,#bdc3c7 60%,#95a5a6 100%);box-shadow:0 0 15px rgba(149,165,166,0.5)}
.sun.sad::before{border-color:#95a5a6;opacity:0.3;animation:none}
.sun.sad::after{display:none}
.sun.neutral{background:radial-gradient(circle,#fdeaa7 0%,#f39c12 60%,#e67e22 100%);box-shadow:0 0 25px rgba(243,156,18,0.6)}
.sun.neutral::before{border-color:#f39c12;opacity:0.5;animation:rays 6s infinite linear}
.motivation{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#2c3e50;font-size:13px;text-align:center;font-weight:600;text-shadow:none;opacity:0.95;transition:all 0.5s;max-width:85%;padding:12px 20px;background:rgba(255,255,255,0.95);border-radius:20px;z-index:250;backdrop-filter:blur(5px);border:2px solid #e0e0e0;box-shadow:0 4px 15px rgba(0,0,0,0.15)}
.motivation.compact{bottom:220px;top:auto;transform:translateX(-50%);font-size:11px;max-width:80%;padding:8px 15px;opacity:0;pointer-events:none;visibility:hidden}
@keyframes bulbGlow{0%,100%{opacity:0.7;transform:translate(-50%,-50%) scale(1)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.15);filter:drop-shadow(0 0 15px rgba(255,235,59,0.9))}}
@keyframes fadeOut{0%,75%{opacity:1}100%{opacity:0}}
@keyframes rays{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
@keyframes glow{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}

.audio-controls{display:flex;gap:3px;z-index:150}
.audio-btn{width:20px;height:20px;border-radius:50%;background:rgba(255,255,255,0.85);border:1.5px solid #3498db;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:11px;line-height:1;transition:all 0.3s;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.audio-btn:hover{transform:scale(1.08);box-shadow:0 2px 6px rgba(52,152,219,0.3)}
.audio-btn.muted{background:rgba(231,76,60,0.85);border-color:#c0392b}
.audio-btn.muted:hover{box-shadow:0 2px 6px rgba(231,76,60,0.3)}

@media (min-width: 600px) {
  #gameContainer{max-width:480px;box-shadow:0 0 20px rgba(0,0,0,0.2)}
}

@media (max-width: 480px) {
  #gameContainer{max-width:100vw}
}
</style>

<!-- BibliothÃ¨que Supabase pour sauvegarde en ligne -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="../supabase-config-dove.js"></script>

</head>
<body>
<div id="gameContainer">
<canvas id="gameCanvas"></canvas>
<div class="landscape"></div>
<div class="sun neutral" id="sun"></div>

<!-- Menu Pause -->
<div id="pauseMenu" style="position:absolute;top:70px;left:10px;background:rgba(255,255,255,0.8);border-radius:15px;box-shadow:0 4px 15px rgba(0,0,0,0.2);padding:10px;z-index:150;display:none;">
  <button onclick="document.getElementById('pauseMenu').style.display='none'" style="width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.95);border:2px solid rgba(0,0,0,0.1);font-size:11px;font-weight:bold;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,0.2);transition:all 0.3s;margin-bottom:8px;display:block;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" title="Fermer le menu">O/I</button>
  
  <div style="display:flex;flex-direction:column;gap:8px;">
    <div onclick="togglePause(); document.getElementById('pauseMenu').style.display='none';" style="cursor:pointer;font-size:20px;padding:8px;border-radius:8px;transition:all 0.2s;background:rgba(231,76,60,0.1);text-align:center;" onmouseover="this.style.background='rgba(231,76,60,0.2)'" onmouseout="this.style.background='rgba(231,76,60,0.1)'" title="Pause / Reprendre">â¸ï¸</div>
    
    <div id="langFlag" onclick="showLanguageSelector(); document.getElementById('pauseMenu').style.display='none';" style="cursor:pointer;font-size:20px;padding:8px;border-radius:8px;transition:all 0.2s;background:rgba(243,156,18,0.1);text-align:center;" onmouseover="this.style.background='rgba(243,156,18,0.2)'" onmouseout="this.style.background='rgba(243,156,18,0.1)'" title="Changer de langue">ğŸ‡«ğŸ‡·</div>
    
    <div onclick="showStats(); document.getElementById('pauseMenu').style.display='none';" style="cursor:pointer;font-size:20px;padding:8px;border-radius:8px;transition:all 0.2s;background:rgba(52,152,219,0.1);text-align:center;" onmouseover="this.style.background='rgba(52,152,219,0.2)'" onmouseout="this.style.background='rgba(52,152,219,0.1)'" title="Mes TrÃ©sors">ğŸ’</div>
    
    <div class="audio-btn" id="musicBtn" onclick="document.getElementById('pauseMenu').style.display='none';" style="cursor:pointer;font-size:20px;padding:8px;border-radius:8px;transition:all 0.2s;background:rgba(155,89,182,0.1);text-align:center;" onmouseover="this.style.background='rgba(155,89,182,0.2)'" onmouseout="this.style.background='rgba(155,89,182,0.1)'" title="Musique">â™«</div>
    
    <div class="audio-btn" id="sfxBtn" onclick="document.getElementById('pauseMenu').style.display='none';" style="cursor:pointer;font-size:20px;padding:8px;border-radius:8px;transition:all 0.2s;background:rgba(155,89,182,0.1);text-align:center;" onmouseover="this.style.background='rgba(155,89,182,0.2)'" onmouseout="this.style.background='rgba(155,89,182,0.1)'" title="Effets sonores">â™ª</div>
  </div>
</div>

<!-- Bouton pour ouvrir le menu -->
<button onclick="document.getElementById('pauseMenu').style.display='block'" style="position:absolute;top:70px;left:10px;width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.95);border:2px solid rgba(0,0,0,0.1);font-size:11px;font-weight:bold;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,0.2);z-index:140;transition:all 0.3s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" title="Menu">O/I</button>

<div id="ui" style="position:absolute;top:10px;left:20px;right:20px;display:flex;justify-content:center;align-items:center;background:rgba(255,255,255,0.7);padding:6px 20px;border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,0.1);backdrop-filter:blur(10px);transition:opacity 0.3s, transform 0.3s;z-index:100;">
<div style="display:flex;gap:15px;align-items:center;">
<div style="font-weight:700;color:#667eea;font-size:18px;"><span id="score">0</span> <span style="font-size:12px;opacity:0.7;">pts</span></div>
<div style="color:#3498db;font-weight:600;">â˜ï¸ <span id="clouds">0</span></div>
<div style="color:#9b59b6;font-weight:600;">Niv. <span id="level">1</span></div>
<div style="color:#e74c3c;font-weight:600;"><span id="lives">3</span> â¤ï¸</div>
<div style="color:#f39c12;font-weight:600;">â­ <span id="starStock">0</span></div>
</div>
</div>
<div id="message"></div>
<button id="startButton"></button>
<div class="motivation">"La vie est souvent un long combat, il faut du courage et de la force pour tenir bon aux mauvais jours. Vaillant hÃ©ros, lÃ¨ve-toi, et avec l'amour de Dieu transforme les nuages gris en bien."</div>
</div>

<script>
// ============================================
// ğŸŒ SYSTEM DE TRADUCTION MULTILINGUE
// ============================================
// SYSTÃˆME DE TRADUCTION (utilise translations.js)
// ============================================

let menuVisible = true;
let menuHideTimeout = null;
let pausedState = null;

function togglePause() {
  const ui = document.getElementById('ui');
  const toggleBtn = document.getElementById('menuToggle');
  
  if (state === 'playing') {
    // Mettre en pause
    pausedState = state;
    state = 'paused';
  } else if (state === 'paused') {
    // Reprendre le jeu
    state = pausedState || 'playing';
    pausedState = null;
  }
}

// Masquer le menu automatiquement aprÃ¨s le dÃ©marrage du jeu
function autoHideMenuOnStart() {
  // DÃ©sactivÃ© - le menu reste toujours visible
}

// Langue actuelle (par dÃ©faut: franÃ§ais)
let currentLang = 'fr';

// Fonction pour changer de langue
function setLanguage(langCode) {
  if (languageExists(langCode)) {
    currentLang = langCode;
    localStorage.setItem('doveGameLang', langCode);
    updateUILanguage();
  }
}

// Fonction pour obtenir une traduction
function t(key, params = {}) {
  let value = getTranslation(currentLang, key);
  
  if (!value) return key;
  
  // Remplacer les paramÃ¨tres {param}
  if (typeof value === 'string') {
    Object.keys(params).forEach(param => {
      value = value.replace(new RegExp(`\\{${param}\\}`, 'g'), params[param]);
    });
  }
  
  return value;
}

// Fonction pour mettre Ã  jour la langue de l'interface
function updateUILanguage() {
  // Mettre Ã  jour les textes de l'UI si nÃ©cessaire
  if (state === 'start' || state === 'gameOver') {
    // Recharger l'Ã©cran
  }
}

// Charger la langue sauvegardÃ©e
const savedLang = localStorage.getItem('doveGameLang');
if (savedLang && languageExists(savedLang)) {
  currentLang = savedLang;
}

// Fonction pour obtenir le drapeau de la langue actuelle
function getCurrentLanguageFlag() {
  const flags = {
    'fr': 'ğŸ‡«ğŸ‡·', 'en': 'ğŸ‡¬ğŸ‡§', 'es': 'ğŸ‡ªğŸ‡¸', 'pt': 'ğŸ‡µğŸ‡¹',
    'de': 'ğŸ‡©ğŸ‡ª', 'it': 'ğŸ‡®ğŸ‡¹', 'nl': 'ğŸ‡³ğŸ‡±', 'ru': 'ğŸ‡·ğŸ‡º',
    'ar': 'ğŸ‡¸ğŸ‡¦', 'zh': 'ğŸ‡¨ğŸ‡³', 'ja': 'ğŸ‡¯ğŸ‡µ', 'ko': 'ğŸ‡°ğŸ‡·',
    'hi': 'ğŸ‡®ğŸ‡³', 'tr': 'ğŸ‡¹ğŸ‡·'
  };
  return flags[currentLang] || 'ğŸŒ';
}

// Mettre Ã  jour le drapeau dans l'UI
function updateLanguageFlag() {
  const langFlagEl = document.getElementById('langFlag');
  if (langFlagEl) {
    langFlagEl.textContent = getCurrentLanguageFlag();
  }
}

function showTestimonies() {
  const lang = currentLang || 'fr';
  const testimonies = getTestimonies(lang);
  
  const testimonyDiv = document.createElement('div');
  testimonyDiv.id = 'testimonyDisplay';
  testimonyDiv.style.cssText = `
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 500px;
    max-height: 85vh;
    background: linear-gradient(135deg, rgba(231,76,60,0.98) 0%, rgba(241,196,15,0.98) 100%);
    color: white;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 10px 50px rgba(0,0,0,0.5);
    z-index: 500;
    overflow-y: auto;
  `;
  
  testimonyDiv.innerHTML = `
    <button onclick="document.getElementById('testimonyDisplay').remove()" style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.3);color:white;border:none;border-radius:50%;width:35px;height:35px;font-size:20px;cursor:pointer;font-weight:bold;line-height:1;">âœ•</button>
    <h2 style="text-align:center;margin-bottom:20px;font-size:24px;">ğŸ’¬ TÃ©moignages d'Espoir</h2>
    
    ${testimonies.map((testimony, index) => `
      <div style="margin-bottom:15px;">
        <button onclick="const content=this.nextElementSibling;const arrow=this.querySelector('span');if(content.style.display==='none'||content.style.display===''){content.style.display='block';arrow.textContent='â–¼';}else{content.style.display='none';arrow.textContent='â–¶';}" 
          style="width:100%;text-align:left;background:rgba(255,255,255,0.2);border:2px solid rgba(255,255,255,0.3);color:white;padding:15px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;display:flex;align-items:center;gap:10px;transition:all 0.3s;"
          onmouseover="this.style.background='rgba(255,255,255,0.3)'"
          onmouseout="this.style.background='rgba(255,255,255,0.2)'">
          <span style="font-size:12px;">â–¶</span>
          <span style="flex:1;">âœ¨ ${testimony.title}</span>
        </button>
        <div style="display:none;background:rgba(255,255,255,0.15);padding:20px;border-radius:0 0 10px 10px;margin-top:-5px;border:2px solid rgba(255,255,255,0.2);border-top:none;">
          <div style="font-size:14px;line-height:1.8;text-align:justify;white-space:pre-line;opacity:0.95;">
            ${testimony.text}
          </div>
          <p style="margin-top:15px;text-align:right;font-style:italic;font-size:13px;opacity:0.8;">â€” ${testimony.author}</p>
        </div>
      </div>
    `).join('')}
    
    <div style="margin-bottom:15px;">
      <button onclick="const content=this.nextElementSibling;const arrow=this.querySelector('span');if(content.style.display==='none'||content.style.display===''){content.style.display='block';arrow.textContent='â–¼';}else{content.style.display='none';arrow.textContent='â–¶';}" 
        style="width:100%;text-align:left;background:rgba(231,76,60,0.3);border:2px solid rgba(231,76,60,0.4);color:white;padding:15px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;display:flex;align-items:center;gap:10px;transition:all 0.3s;"
        onmouseover="this.style.background='rgba(231,76,60,0.4)'"
        onmouseout="this.style.background='rgba(231,76,60,0.3)'">
        <span style="font-size:12px;">â–¶</span>
        <span style="flex:1;">ğŸ’ TrÃ©sor de Vie - Emmanuel</span>
      </button>
      <div style="display:none;background:linear-gradient(135deg, rgba(231,76,60,0.15), rgba(241,196,15,0.15));padding:18px;border-radius:0 0 10px 10px;margin-top:-5px;border:2px solid rgba(231,76,60,0.3);border-top:none;max-height:300px;overflow-y:auto;">
        <div style="font-size:13px;line-height:1.7;text-align:justify;opacity:0.95;">
          <p style="margin:10px 0;">Il fut un temps oÃ¹ la maladie m'a terriblement isolÃ© et de sombres nuages est venue envahir ma vie. J'ai tentÃ© d'abandonner mais avant j'ai criÃ© Ã  Dieu ! <strong>C'est Ã  toi que je donne ma vie et pas aux ombres sournoises.</strong></p>
          
          <p style="margin:10px 0;">Comme une priÃ¨re, mon cri fut entendu et ma vie a changÃ© dÃ¨s ce jour oÃ¹ j'ai su dans mon cÅ“ur que <em>je suis aimÃ© comme je suis</em>. Un long travail de confiance, de courage, de changement s'amorÃ§a en moi.</p>
          
          <p style="margin:10px 0;">J'ai appris des erreurs, j'ai appris Ã  ne pas regarder en arriÃ¨re toujours sans jamais oublier. Mais j'ai surtout appris Ã  regarder l'avenir Ã  patience, espÃ©rance et joie.</p>
          
          <p style="margin:10px 0;">Une joie que j'ai retrouvÃ©e dans la louange et une adoration de Dieu sauveur, Ã  celui qui m'a tendu la main quand personne ne pouvait Ãªtre lÃ  pour moi. Il m'a sorti de la vallÃ©e de la mort et fait voir ce qui est vraiment important : <strong>la vie simple, ordinaire</strong>.</p>
          
          <p style="margin:10px 0;">J'ai vu au-delÃ  de mes dÃ©sirs matÃ©rialistes, j'ai vu qu'il fallait regarder Ã  ce que j'ai et pas Ã  ce que je n'ai pas. Et aimer ce que je suis, comme je veux Ãªtre. <em>J'ai vu l'espoir en face.</em></p>
          
          <p style="margin:10px 0;">J'ai demandÃ© et j'ai reÃ§u des rÃ©ponses ineffables qui a produit en moi une foi inÃ©branlable. Ã€ travers les difficultÃ©s j'ai grandi et je ne regrette pas d'avoir persÃ©vÃ©rÃ©, espÃ©rÃ© encore et encore car <strong>chaque colline cachait des trÃ©sors de vie</strong>, chaque montagne vaincue par le courage de bouger a portÃ© un meilleur avenir, des souvenirs de vie extraordinaire, des rencontres et lieux merveilleux.</p>
          
          <p style="margin:10px 0;text-align:center;font-weight:bold;color:#fff;font-size:14px;padding:10px;background:rgba(255,255,255,0.2);border-radius:8px;">
            ğŸ•Šï¸ C'est pour cela que JÃ©sus te dit : N'abandonne jamais, persÃ©vÃ¨re jusqu'Ã  l'impossible ! ğŸ•Šï¸
          </p>
        </div>
      </div>
    </div>
    
    <div style="text-align:center;margin-top:20px;">
      <button onclick="document.getElementById('testimonyDisplay').remove()" style="
        padding:12px 24px;
        background:#27ae60;
        color:white;
        border:none;
        border-radius:10px;
        font-size:16px;
        font-weight:bold;
        cursor:pointer;
        box-shadow:0 4px 6px rgba(0,0,0,0.2);
        transition:transform 0.2s;
      " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
        Fermer
      </button>
    </div>
  `;
  
  document.body.appendChild(testimonyDiv);
}

// Fonction pour afficher le sÃ©lecteur de langue
function showLanguageSelector() {
  const languages = [
    { code: 'fr', name: 'FranÃ§ais', flag: 'ğŸ‡«ğŸ‡·' },
    { code: 'en', name: 'English', flag: 'ğŸ‡¬ğŸ‡§' },
    { code: 'es', name: 'EspaÃ±ol', flag: 'ğŸ‡ªğŸ‡¸' },
    { code: 'pt', name: 'PortuguÃªs', flag: 'ğŸ‡µğŸ‡¹' },
    { code: 'de', name: 'Deutsch', flag: 'ğŸ‡©ğŸ‡ª' },
    { code: 'it', name: 'Italiano', flag: 'ğŸ‡®ğŸ‡¹' },
    { code: 'ru', name: 'Ğ ÑƒÑÑĞºĞ¸Ğ¹', flag: 'ğŸ‡·ğŸ‡º' },
    { code: 'zh', name: 'ä¸­æ–‡', flag: 'ğŸ‡¨ğŸ‡³' },
    { code: 'ar', name: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', flag: 'ğŸ‡¸ğŸ‡¦' },
    { code: 'hi', name: 'à¤¹à¤¿à¤¨à¥à¤¦à¥€', flag: 'ğŸ‡®ğŸ‡³' },
    { code: 'sw', name: 'Kiswahili', flag: 'ğŸ‡°ğŸ‡ª' },
    { code: 'ko', name: 'í•œêµ­ì–´', flag: 'ğŸ‡°ğŸ‡·' },
    { code: 'ja', name: 'æ—¥æœ¬èª', flag: 'ğŸ‡¯ğŸ‡µ' },
    { code: 'pl', name: 'Polski', flag: 'ğŸ‡µğŸ‡±' }
  ];
  
  const langDiv = document.createElement('div');
  langDiv.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, rgba(52,152,219,0.95) 0%, rgba(41,128,185,0.95) 100%);
    padding: 25px;
    border-radius: 20px;
    z-index: 1000;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    max-width: 400px;
    max-height: 80vh;
    overflow-y: auto;
  `;
  
  langDiv.innerHTML = `
    <button onclick="this.parentElement.remove()" style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.3);color:white;border:none;border-radius:50%;width:35px;height:35px;font-size:20px;cursor:pointer;font-weight:bold;line-height:1;">âœ•</button>
    <h2 style="text-align:center;margin-bottom:20px;color:white;font-size:22px;">ğŸŒ Choisir la langue</h2>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      ${languages.map(lang => `
        <button onclick="selectLanguage('${lang.code}')" style="
          background: ${currentLang === lang.code ? 'rgba(46,204,113,0.9)' : 'rgba(255,255,255,0.9)'};
          border: 3px solid ${currentLang === lang.code ? '#27ae60' : 'transparent'};
          padding: 12px;
          border-radius: 12px;
          cursor: pointer;
          font-size: 14px;
          font-weight: bold;
          color: #2c3e50;
          transition: all 0.3s;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
        " onmouseover="this.style.transform='scale(1.05)';" onmouseout="this.style.transform='scale(1)';">
          <span style="font-size:24px;">${lang.flag}</span>
          <span>${lang.name}</span>
        </button>
      `).join('')}
    </div>
  `;
  
  document.body.appendChild(langDiv);
}

// Fonction pour sÃ©lectionner une langue
function selectLanguage(langCode) {
  setLanguage(langCode);
  // Mettre Ã  jour le drapeau dans l'UI
  updateLanguageFlag();
  // Fermer le sÃ©lecteur
  const selector = document.querySelector('div[style*="grid-template-columns"]');
  if (selector && selector.parentElement) {
    selector.parentElement.remove();
  }
  // Afficher un message de confirmation
  msg(`ğŸŒ ${t('ui.language')} : ${langCode.toUpperCase()}`);
}

// ============================================
// ğŸ’¾ SYSTÃˆME DE SAUVEGARDE LOCALE
// ============================================

const SAVE_KEY = 'doveGameSave';

// Structure des donnÃ©es de sauvegarde
// Structure des donnÃ©es de sauvegarde
let gameData = {
  // Progression
  highestLevelReached: 1,
  highScore: 0,
  totalCloudsDestroyed: 0,
  totalGamesPlayed: 0,
  totalPlayTime: 0, // en secondes
  starStock: 0, // Stock d'Ã©toiles accumulÃ©es
  
  // Statistiques
  stats: {
    totalShots: 0,
    totalHits: 0,
    totalMisses: 0,
    totalPowerUpsCollected: 0,
    totalLivesLost: 0,
    longestSurvival: 0,
    perfectLevels: 0,
    deathsByClouds: 0,
    deathsByRain: 0
  },
  
  // Achievements (pour usage futur)
  achievements: [],
  
  // Niveaux bonus
  bonusLevels: {
    completed: [false, false, false, false], // 4 niveaux bonus
    bestScores: [0, 0, 0, 0],
    totalItemsCollected: 0
  },
  
  // DerniÃ¨re session
  lastPlayed: null,
  lastScore: 0,
  lastLevel: 1
};

// Variables globales pour le jeu (dÃ©clarÃ©es avant loadGameData)
let starCount = 0; // Compteur d'Ã©toiles accumulÃ©es
let lastStarChangeTime = 0; // Pour faire disparaÃ®tre le texte rapidement

// Charger les donnÃ©es sauvegardÃ©es
function loadGameData() {
  try {
    const savedData = localStorage.getItem(SAVE_KEY);
    if (savedData) {
      const parsed = JSON.parse(savedData);
      // Fusionner avec la structure par dÃ©faut pour compatibilitÃ©
      gameData = { ...gameData, ...parsed };
      // Restaurer le stock d'Ã©toiles
      if (typeof gameData.starStock !== 'undefined') {
        starCount = gameData.starStock;
      }
      console.log('ğŸ’¾ DonnÃ©es chargÃ©es:', gameData);
      console.log('â­ Stock d\'Ã©toiles restaurÃ©:', starCount);
      return true;
    }
  } catch (error) {
    console.error('âŒ Erreur lors du chargement:', error);
  }
  return false;
}

// Sauvegarder les donnÃ©es
// ========== SYSTÃˆME DE BASE DE DONNÃ‰ES SIMPLIFIÃ‰ ==========
// Sauvegarde uniquement : score, email, surnom
const DB_KEY = 'doveGameScores';

// Structure simplifiÃ©e pour la base de donnÃ©es
let playerProfile = {
  nickname: '',
  email: '',
  bestScore: 0,
  highestLevel: 1,
  lastPlayed: null
};

// Charger le profil depuis localStorage
function loadPlayerProfile() {
  try {
    const saved = localStorage.getItem(DB_KEY);
    if (saved) {
      playerProfile = JSON.parse(saved);
      console.log('ğŸ’¾ Profil chargÃ©:', playerProfile);
      return true;
    }
  } catch (error) {
    console.error('âŒ Erreur chargement profil:', error);
  }
  return false;
}

// Sauvegarder le profil dans localStorage
function savePlayerProfile() {
  try {
    playerProfile.lastPlayed = new Date().toISOString();
    localStorage.setItem(DB_KEY, JSON.stringify(playerProfile));
    console.log('ğŸ’¾ Profil sauvegardÃ©:', playerProfile);
    return true;
  } catch (error) {
    console.error('âŒ Erreur sauvegarde profil:', error);
    return false;
  }
}

// Mettre Ã  jour le score si meilleur
function updateBestScore(newScore) {
  if (newScore > playerProfile.bestScore) {
    playerProfile.bestScore = newScore;
    savePlayerProfile();
    return true; // Nouveau record !
  }
  return false;
}

// Mettre Ã  jour le niveau maximum atteint
function updateHighestLevel(newLevel) {
  if (newLevel > playerProfile.highestLevel) {
    playerProfile.highestLevel = newLevel;
    savePlayerProfile();
    
    // Sauvegarde automatique locale
    localStorage.setItem('doveGameData', JSON.stringify(gameData));
    
    // Sauvegarde automatique cloud (si connectÃ©)
    autoSaveToCloud();
    
    console.log('ğŸ¯ Nouveau niveau dÃ©bloquÃ©:', newLevel, 'ğŸ’¾ Sauvegarde auto OK');
    return true; // Nouveau niveau !
  }
  return false;
}

// Demander les informations du joueur au Game Over
function promptPlayerInfo() {
  if (!playerProfile.nickname || !playerProfile.email) {
    const nickname = prompt('ğŸ® Entre ton surnom pour le classement :') || 'Anonyme';
    const email = prompt('ğŸ“§ Entre ton email (optionnel) :') || '';
    
    playerProfile.nickname = nickname;
    playerProfile.email = email;
    savePlayerProfile();
  }
}

// Exporter le profil pour la base de donnÃ©es
function exportProfileData() {
  const data = {
    nickname: playerProfile.nickname,
    email: playerProfile.email,
    score: playerProfile.bestScore,
    level: playerProfile.highestLevel,
    date: playerProfile.lastPlayed
  };
  
  const jsonData = JSON.stringify(data, null, 2);
  const blob = new Blob([jsonData], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `dove-score-${playerProfile.nickname}-${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  
  console.log('ğŸ“¤ Profil exportÃ©:', data);
  showPopup('\u2705 Score export\u00e9 !\n\nPartage ce fichier pour le classement global.', '\ud83c\udfc6', 'success');
}

// Afficher les conseils de vie dans les onglets
function showLifeTip(category) {
  const tips = {
    faith: {
      title: '\u271d\ufe0f Conseils de Foi',
      content: [
        '\ud83d\udcab "La foi est la ferme assurance des choses qu\'on espÃ¨re" - HÃ©breux 11:1',
        '\ud83d\ude4f Prie chaque jour, mÃªme quelques minutes suffisent pour fortifier ton Ã¢me',
        '\ud83d\udcd6 Lis la Bible rÃ©guliÃ¨rement pour nourrir ta foi et trouver des rÃ©ponses',
        '\u2728 Fais confiance Ã  Dieu dans les moments difficiles, Il a un plan pour toi',
        '\ud83c\udf1f Entoure-toi de croyants qui t\'encouragent dans ta foi'
      ]
    },
    courage: {
      title: '\ud83d\udcaa Conseils de Courage',
      content: [
        '\ud83e\udd81 "Sois fort et courageux, ne crains point" - JosuÃ© 1:9',
        '\ud83d\udd25 Affronte tes peurs une par une, chaque petite victoire compte',
        '\ud83c\udfaf Fixe-toi des objectifs clairs et avance pas Ã  pas vers eux',
        '\ud83d\udc4a N\'abandonne jamais, mÃªme quand c\'est difficile - la persÃ©vÃ©rance paie',
        '\u2b50 Rappelle-toi tes succÃ¨s passÃ©s pour trouver la force de continuer'
      ]
    },
    peace: {
      title: '\ud83d\udd4a\ufe0f Conseils de Paix',
      content: [
        '\ud83c\udf3f "Je vous laisse la paix, je vous donne ma paix" - Jean 14:27',
        '\ud83e\uddd8 Prends du temps chaque jour pour te reposer et mÃ©diter',
        '\ud83c\udf3a Pardonne ceux qui t\'ont blessÃ©, libÃ¨re-toi du poids de la rancune',
        '\ud83c\udf08 Cherche la paix dans les petites choses : la nature, la musique, la priÃ¨re',
        '\ud83d\udc95 Entoure-toi de personnes positives qui t\'apportent de la sÃ©rÃ©nitÃ©'
      ]
    },
    love: {
      title: '\u2764\ufe0f Conseils d\'Amour',
      content: [
        '\ud83d\udc96 "Aimez-vous les uns les autres comme je vous ai aimÃ©s" - Jean 13:34',
        '\ud83e\udd1d Montre de la bienveillance envers tous, mÃªme ceux qui sont diffÃ©rents',
        '\ud83c\udf81 Donne sans attendre en retour, l\'amour vÃ©ritable est dÃ©sintÃ©ressÃ©',
        '\ud83d\udc42 Ã‰coute vraiment les autres, sois prÃ©sent pour ceux qui souffrent',
        '\u2728 Commence par t\'aimer toi-mÃªme : tu es prÃ©cieux(se) aux yeux de Dieu'
      ]
    }
  };
  
  const tip = tips[category];
  const contentDiv = document.getElementById('lifeTipContent');
  
  if (contentDiv && tip) {
    contentDiv.innerHTML = `
      <h4 style="margin-top:0;text-align:center;color:#fff;font-size:16px;margin-bottom:15px;">${tip.title}</h4>
      <div style="text-align:left;">
        ${tip.content.map(line => `<p style="margin:10px 0;font-size:13px;line-height:1.6;">${line}</p>`).join('')}
      </div>
    `;
  }
}

// Charger le profil au dÃ©marrage
loadPlayerProfile();

// ========== ANCIEN SYSTÃˆME (GARDÃ‰ POUR COMPATIBILITÃ‰) ==========
function saveGameData() {
  try {
    gameData.lastPlayed = new Date().toISOString();
    // Sauvegarder le stock d'Ã©toiles actuel
    gameData.starStock = starCount;
    localStorage.setItem(SAVE_KEY, JSON.stringify(gameData));
    console.log('ğŸ’¾ DonnÃ©es sauvegardÃ©es (â­ Ã©toiles:', starCount + ')');
    return true;
  } catch (error) {
    console.error('âŒ Erreur lors de la sauvegarde:', error);
    return false;
  }
}

// Mettre Ã  jour les statistiques en temps rÃ©el
function updateStats(statName, value = 1) {
  if (gameData.stats.hasOwnProperty(statName)) {
    gameData.stats[statName] += value;
  }
}

// Sauvegarder la progression du niveau
function saveProgress(level, score, totalClouds) {
  let newRecord = false;
  
  // Mise Ã  jour du meilleur niveau atteint
  if (level > gameData.highestLevelReached) {
    gameData.highestLevelReached = level;
    newRecord = true;
  }
  
  // Mise Ã  jour du meilleur score
  if (score > gameData.highScore) {
    gameData.highScore = score;
    newRecord = true;
  }
  
  // Mise Ã  jour des nuages dÃ©truits (seulement le delta depuis la derniÃ¨re sauvegarde)
  const cloudsDelta = totalClouds - lastSavedCloudsCount;
  if (cloudsDelta > 0) {
    gameData.totalCloudsDestroyed += cloudsDelta;
    lastSavedCloudsCount = totalClouds;
  }
  
  // Sauvegarder le stock d'Ã©toiles
  gameData.starStock = starCount;
  
  // DerniÃ¨re session
  gameData.lastScore = score;
  gameData.lastLevel = level;
  
  // Sauvegarder localement tous les 100 nuages
  if (gameData.totalCloudsDestroyed % 100 === 0) {
    saveGameData();
    console.log('ğŸ’¾ Sauvegarde locale (100 nuages)');
  } else {
    saveGameData();
  }
  
  // Sauvegarde cloud tous les 200 nuages si nouveau record
  if (newRecord && gameData.totalCloudsDestroyed % 200 === 0) {
    const nickname = localStorage.getItem('dovePlayerNickname');
    const email = localStorage.getItem('dovePlayerEmail');
    
    if (nickname && email) {
      console.log('ğŸ† Nouveau record + 200 nuages - Sauvegarde cloud...');
      setTimeout(() => {
        autoSaveToCloud();
      }, 1000);
    }
  }
}

// Sauvegarder Ã  la fin de la partie
function saveGameEnd(finalScore, finalLevel, finalClouds, survivalTime) {
  gameData.totalGamesPlayed++;
  gameData.totalPlayTime += Math.floor(survivalTime / 1000);
  
  if (survivalTime > gameData.stats.longestSurvival) {
    gameData.stats.longestSurvival = survivalTime;
  }
  
  saveProgress(finalLevel, finalScore, finalClouds);
}

// RÃ©initialiser toutes les donnÃ©es (pour debug ou reset complet)
function resetGameData() {
  if (confirm('âš ï¸ Voulez-vous vraiment rÃ©initialiser toutes vos donnÃ©es ?')) {
    localStorage.removeItem(SAVE_KEY);
    gameData = {
      highestLevelReached: 1,
      highScore: 0,
      totalCloudsDestroyed: 0,
      totalGamesPlayed: 0,
      totalPlayTime: 0,
      stats: {
        totalShots: 0,
        totalHits: 0,
        totalMisses: 0,
        totalPowerUpsCollected: 0,
        totalLivesLost: 0,
        longestSurvival: 0,
        perfectLevels: 0,
        deathsByClouds: 0,
        deathsByRain: 0
      },
      achievements: [],
      bonusLevels: {
        completed: [false, false, false, false],
        bestScores: [0, 0, 0, 0],
        totalItemsCollected: 0
      },
      lastPlayed: null,
      lastScore: 0,
      lastLevel: 1
    };
    console.log('ğŸ”„ DonnÃ©es rÃ©initialisÃ©es');
    return true;
  }
  return false;
}

// Exporter les donnÃ©es (pour backup)
function exportGameData() {
  // CrÃ©er un canvas pour l'image
  const canvas = document.createElement('canvas');
  canvas.width = 1080;
  canvas.height = 1080;
  const ctx = canvas.getContext('2d');
  
  // Fond dÃ©gradÃ© bleu ciel
  const gradient = ctx.createLinearGradient(0, 0, 0, 1080);
  gradient.addColorStop(0, '#87ceeb');
  gradient.addColorStop(0.5, '#b8d8f8');
  gradient.addColorStop(1, '#e3f2fd');
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, 1080, 1080);
  
  // Dessiner le soleil
  ctx.shadowBlur = 30;
  ctx.shadowColor = '#ffd700';
  ctx.fillStyle = '#ffd700';
  ctx.beginPath();
  ctx.arc(900, 200, 70, 0, Math.PI * 2);
  ctx.fill();
  ctx.shadowBlur = 0;
  
  // Rayons du soleil
  ctx.strokeStyle = 'rgba(255, 215, 0, 0.3)';
  ctx.lineWidth = 3;
  for (let i = 0; i < 12; i++) {
    const angle = (i * 30) * Math.PI / 180;
    ctx.beginPath();
    ctx.moveTo(900 + Math.cos(angle) * 80, 200 + Math.sin(angle) * 80);
    ctx.lineTo(900 + Math.cos(angle) * 120, 200 + Math.sin(angle) * 120);
    ctx.stroke();
  }
  
  // Petits nuages blancs
  const drawCloud = (x, y, size) => {
    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
    ctx.beginPath();
    ctx.arc(x, y, size, 0, Math.PI * 2);
    ctx.arc(x + size * 0.8, y - size * 0.3, size * 0.8, 0, Math.PI * 2);
    ctx.arc(x + size * 1.6, y, size * 0.9, 0, Math.PI * 2);
    ctx.arc(x + size * 2.2, y + size * 0.2, size * 0.7, 0, Math.PI * 2);
    ctx.fill();
  };
  
  drawCloud(150, 250, 25);
  drawCloud(800, 320, 30);
  drawCloud(300, 500, 20);
  drawCloud(950, 550, 28);
  drawCloud(100, 600, 22);
  
  // Particules bonus flottantes
  // Ã‰toile
  const drawStar = (x, y, size) => {
    ctx.fillStyle = '#f39c12';
    ctx.shadowBlur = 10;
    ctx.shadowColor = '#f39c12';
    ctx.beginPath();
    for (let i = 0; i < 5; i++) {
      const angle1 = (i * 72 - 90) * Math.PI / 180;
      const angle2 = ((i * 72) + 36 - 90) * Math.PI / 180;
      if (i === 0) ctx.moveTo(x + Math.cos(angle1) * size, y + Math.sin(angle1) * size);
      else ctx.lineTo(x + Math.cos(angle1) * size, y + Math.sin(angle1) * size);
      ctx.lineTo(x + Math.cos(angle2) * size * 0.5, y + Math.sin(angle2) * size * 0.5);
    }
    ctx.closePath();
    ctx.fill();
    ctx.shadowBlur = 0;
  };
  
  // CÅ“ur
  const drawHeart = (x, y, size) => {
    ctx.fillStyle = '#e74c3c';
    ctx.shadowBlur = 10;
    ctx.shadowColor = '#e74c3c';
    ctx.beginPath();
    ctx.moveTo(x, y + size * 0.3);
    ctx.bezierCurveTo(x, y, x - size * 0.5, y - size * 0.3, x - size * 0.5, y + size * 0.1);
    ctx.bezierCurveTo(x - size * 0.5, y + size * 0.5, x, y + size * 0.7, x, y + size);
    ctx.bezierCurveTo(x, y + size * 0.7, x + size * 0.5, y + size * 0.5, x + size * 0.5, y + size * 0.1);
    ctx.bezierCurveTo(x + size * 0.5, y - size * 0.3, x, y, x, y + size * 0.3);
    ctx.fill();
    ctx.shadowBlur = 0;
  };
  
  // Croix
  const drawCross = (x, y, size) => {
    ctx.strokeStyle = '#3498db';
    ctx.lineWidth = size * 0.3;
    ctx.shadowBlur = 10;
    ctx.shadowColor = '#3498db';
    ctx.beginPath();
    ctx.moveTo(x, y - size);
    ctx.lineTo(x, y + size);
    ctx.moveTo(x - size * 0.7, y);
    ctx.lineTo(x + size * 0.7, y);
    ctx.stroke();
    ctx.shadowBlur = 0;
  };
  
  // Arc-en-ciel
  const drawRainbow = (x, y, size) => {
    const colors = ['#e74c3c', '#f39c12', '#f1c40f', '#2ecc71', '#3498db', '#9b59b6'];
    ctx.lineWidth = size * 0.15;
    for (let i = 0; i < colors.length; i++) {
      ctx.strokeStyle = colors[i];
      ctx.beginPath();
      ctx.arc(x, y + size * 0.8, size - i * (size * 0.15), Math.PI, 0);
      ctx.stroke();
    }
  };
  
  // Disposer les particules
  drawStar(200, 400, 20);
  drawHeart(850, 450, 25);
  drawCross(100, 350, 18);
  drawRainbow(950, 680, 35);
  drawStar(750, 600, 15);
  drawHeart(300, 650, 20);
  
  // Dessiner les montagnes en bas
  // Montagne arriÃ¨re gauche
  ctx.fillStyle = '#b8c5d0';
  ctx.beginPath();
  ctx.moveTo(0, 1080);
  ctx.lineTo(200, 850);
  ctx.lineTo(400, 1080);
  ctx.closePath();
  ctx.fill();
  
  // Montagne arriÃ¨re droite
  ctx.fillStyle = '#b8c5d0';
  ctx.beginPath();
  ctx.moveTo(680, 1080);
  ctx.lineTo(880, 850);
  ctx.lineTo(1080, 1080);
  ctx.closePath();
  ctx.fill();
  
  // Montagne centrale (la plus haute et plus mince)
  ctx.fillStyle = '#e8ecf0';
  ctx.beginPath();
  ctx.moveTo(420, 1080);
  ctx.lineTo(540, 800);
  ctx.lineTo(660, 1080);
  ctx.closePath();
  ctx.fill();
  
  // Sommet neigeux central (plus petit)
  ctx.fillStyle = '#ffffff';
  ctx.beginPath();
  ctx.moveTo(520, 860);
  ctx.lineTo(540, 800);
  ctx.lineTo(560, 860);
  ctx.closePath();
  ctx.fill();
  
  // Montagne avant gauche
  ctx.fillStyle = '#d0dae3';
  ctx.beginPath();
  ctx.moveTo(0, 1080);
  ctx.lineTo(150, 900);
  ctx.lineTo(350, 1080);
  ctx.closePath();
  ctx.fill();
  
  // Montagne avant droite
  ctx.fillStyle = '#d0dae3';
  ctx.beginPath();
  ctx.moveTo(730, 1080);
  ctx.lineTo(930, 900);
  ctx.lineTo(1080, 1080);
  ctx.closePath();
  ctx.fill();
  
  // Dessiner la colombe (style du jeu)
  const birdX = 440;
  const birdY = 300;
  const scale = 4;
  
  // Corps de l'oiseau (sans halo jaune)
  ctx.shadowBlur = 0;
  ctx.fillStyle = '#ffffff';
  ctx.strokeStyle = '#2c3e50';
  ctx.lineWidth = 3;
  
  // TÃªte
  ctx.beginPath();
  ctx.moveTo(birdX + 20*scale, birdY + 8*scale);
  ctx.lineTo(birdX + 15*scale, birdY + 22*scale);
  ctx.lineTo(birdX + 25*scale, birdY + 22*scale);
  ctx.closePath();
  ctx.fill();
  ctx.stroke();
  
  // Aile gauche
  ctx.beginPath();
  ctx.moveTo(birdX + 15*scale, birdY + 12*scale);
  ctx.lineTo(birdX + 2*scale, birdY + 8*scale);
  ctx.lineTo(birdX + 18*scale, birdY + 25*scale);
  ctx.closePath();
  ctx.fill();
  ctx.stroke();
  
  // Aile droite
  ctx.beginPath();
  ctx.moveTo(birdX + 25*scale, birdY + 12*scale);
  ctx.lineTo(birdX + 38*scale, birdY + 8*scale);
  ctx.lineTo(birdX + 22*scale, birdY + 25*scale);
  ctx.closePath();
  ctx.fill();
  ctx.stroke();
  
  // Queue
  ctx.beginPath();
  ctx.moveTo(birdX + 20*scale, birdY + 22*scale);
  ctx.lineTo(birdX + 18*scale, birdY + 30*scale);
  ctx.lineTo(birdX + 22*scale, birdY + 30*scale);
  ctx.closePath();
  ctx.fill();
  ctx.stroke();
  
  ctx.shadowBlur = 0;
  
  // Titre du jeu
  ctx.fillStyle = '#2c3e50';
  ctx.font = 'bold 60px Arial';
  ctx.textAlign = 'center';
  ctx.fillText('Dove of Hope', 540, 150);
  ctx.font = '36px Arial';
  ctx.fillText('Sky Blessing', 540, 200);
  
  // Score
  ctx.fillStyle = '#f39c12';
  ctx.font = 'bold 80px Arial';
  ctx.fillText(`Score: ${gameData.highScore.toLocaleString()}`, 540, 540);
  
  // Niveau
  ctx.fillStyle = '#3498db';
  ctx.font = 'bold 50px Arial';
  ctx.fillText(`Niveau ${gameData.highestLevelReached}`, 540, 620);
  
  // Nuages dÃ©truits
  ctx.fillStyle = '#95a5a6';
  ctx.font = '40px Arial';
  ctx.fillText(`${gameData.totalCloudsDestroyed} nuages dissipÃ©s`, 540, 680);
  
  // Message motivant
  ctx.fillStyle = '#e74c3c';
  ctx.font = 'bold italic 45px Arial';
  ctx.textAlign = 'center';
  const message = 'Courage, vaillant hÃ©ros !';
  ctx.fillText(message, 540, 770);
  
  // Phrase inspirante
  ctx.fillStyle = '#2c3e50';
  ctx.font = '32px Arial';
  ctx.fillText('Transforme les nuages gris', 540, 830);
  ctx.fillText('en lumiÃ¨re divine', 540, 870);
  
  // TÃ©lÃ©charger l'image
  canvas.toBlob((blob) => {
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `dove-of-hope-score-${gameData.highScore}.png`;
    link.click();
    URL.revokeObjectURL(url);
    console.log('ğŸ“¤ Image exportÃ©e');
  });
}

// Importer les donnÃ©es (pour restore)
function importGameData(fileInput) {
  const file = fileInput.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const imported = JSON.parse(e.target.result);
        gameData = { ...gameData, ...imported };
        saveGameData();
        console.log('ğŸ“¥ DonnÃ©es importÃ©es');
        showPopup('\u2705 Donn\u00e9es import\u00e9es avec succ\u00e8s !', '\ud83d\udcbe', 'success');
      } catch (error) {
        console.error('âŒ Erreur lors de l\'import:', error);
        showPopup('\u274c Fichier invalide', '\u26a0\ufe0f', 'error');
      }
    };
    reader.readAsText(file);
  }
}

// Charger les donnÃ©es au dÃ©marrage
loadGameData();

// ============================================
// ï¿½ SYSTÃˆME AUDIO
// ============================================
const audioContext = new (window.AudioContext || window.webkitAudioContext)();
let audioInitialized = false;
let musicEnabled = true;
let sfxEnabled = true;

// Fonction pour initialiser l'AudioContext aprÃ¨s interaction utilisateur
function initAudioContext() {
  if (!audioInitialized) {
    audioInitialized = true;
    console.log('âœ… AudioContext prÃªt');
  }
}

// Playlist de musiques gospel
const gospelPlaylist = [
  'gospel/je-te-donne-ma-vie.mp3', // Toujours en premier
  'gospel/reflet-trompeurs.mp3', // DeuxiÃ¨me chanson
  'gospel/chacun-sa-place-sous-le-ciel-de-papa.mp3',
  'gospel/cours-vers-ta-destinee.mp3',
  'gospel/dans-quel-monde-on-vit.mp3',
  'gospel/elle-ma-dit-il-est-vivant.mp3',
  'gospel/esperance.mp3',
  'gospel/il-est-la-la-avec-nous.mp3',
  'gospel/il-y-a-un-espoir-pour-toi-pour-moi.mp3',
  'gospel/il-y-a-une-chose-que-tu-dois-voir.mp3',
  'gospel/je-veux-prier.mp3',
  'gospel/jesus-connait-ta-vie.mp3',
  'gospel/jai-un-secret-en-moi.mp3',
  'gospel/la-paix-renait-toujours.mp3',
  'gospel/la-parole-est-venue.mp3',
  'gospel/le-torrent-de-larnon.mp3',
  'gospel/les-anges-sont-descendus-vers-toi.mp3',
  'gospel/mise-a-jour-de-mon-coeur.mp3',
  'gospel/nabandonne-jamais.mp3',
  'gospel/nabandonne-pas.mp3',
  'gospel/prends-le-chemin.mp3',
  'gospel/priez-pour-resister-au-mal.mp3',
  'gospel/quand-tout-semblait-sombrer.mp3',
  'gospel/que-je-vive.mp3',
  'gospel/tiens-bon-tiens-bon.mp3',
  'gospel/tu-es-appele-a-porte-la-paix.mp3',
  'gospel/tu-mas-tendue-la-main.mp3',
  'gospel/un-sos-sur-les-flots.mp3'
];

let currentTrackIndex = 0;
let musicAudio = null;
let firstPlay = true; // Pour savoir si c'est le premier lancement
let rainMusicAudio = null; // Audio spÃ©cial pour la pluie
let normalMusicPaused = false; // Pour reprendre la musique normale aprÃ¨s la pluie
const rainMusicPath = 'gospel/un-sos-sur-les-flots.mp3'; // Chanson pour la pluie

// Fonction pour jouer une musique alÃ©atoire
function playRandomMusic() {
  if (!musicEnabled || normalMusicPaused) return;
  
  // Initialiser l'AudioContext si ce n'est pas dÃ©jÃ  fait
  if (!audioInitialized) {
    initAudioContext();
  }
  
  // Si c'est le premier lancement, commencer par "Je te donne ma vie"
  if (firstPlay) {
    currentTrackIndex = 0; // Index 0 = "Je te donne ma vie"
    firstPlay = false;
  } else {
    // Ensuite, jouer alÃ©atoirement
    currentTrackIndex = Math.floor(Math.random() * gospelPlaylist.length);
  }
  
  // CrÃ©er un nouvel Ã©lÃ©ment audio
  if (musicAudio) {
    musicAudio.pause();
    musicAudio = null;
  }
  
  musicAudio = new Audio(gospelPlaylist[currentTrackIndex]);
  musicAudio.volume = 0.3; // Volume modÃ©rÃ©
  
  // Gestion d'erreur amÃ©liorÃ©e pour fichiers manquants
  musicAudio.addEventListener('error', (e) => {
    console.warn('âš ï¸ Impossible de charger:', gospelPlaylist[currentTrackIndex]);
    // Passer Ã  la chanson suivante
    playRandomMusic();
  });
  
  musicAudio.play().catch(err => {
    console.log('â„¹ï¸ Lecture musique diffÃ©rÃ©e (interaction requise)');
  });
  
  // Quand la musique se termine, jouer la suivante
  musicAudio.addEventListener('ended', () => {
    playRandomMusic();
  });
}

// Fonction pour jouer la musique de pluie
function playRainMusic() {
  if (!musicEnabled) return;
  
  // Initialiser l'AudioContext si ce n'est pas dÃ©jÃ  fait
  if (!audioInitialized) {
    initAudioContext();
  }
  
  // Mettre en pause la musique normale
  if (musicAudio && !musicAudio.paused) {
    musicAudio.pause();
    normalMusicPaused = true;
  }
  
  // Si la musique de pluie joue dÃ©jÃ , ne rien faire
  if (rainMusicAudio && !rainMusicAudio.paused) return;
  
  // CrÃ©er et jouer la musique de pluie
  if (rainMusicAudio) {
    rainMusicAudio.pause();
    rainMusicAudio = null;
  }
  
  rainMusicAudio = new Audio(rainMusicPath);
  rainMusicAudio.volume = 0.35; // Un peu plus fort pour la pluie
  rainMusicAudio.loop = true; // Boucle pendant la pluie
  rainMusicAudio.play().catch(err => console.log('Erreur lecture musique pluie:', err));
}

// Fonction pour arrÃªter la musique de pluie et reprendre la normale
function stopRainMusic() {
  if (rainMusicAudio) {
    rainMusicAudio.pause();
    rainMusicAudio.currentTime = 0;
    rainMusicAudio = null;
  }
  
  // Reprendre la musique normale
  normalMusicPaused = false;
  if (musicEnabled && musicAudio && musicAudio.paused) {
    musicAudio.play().catch(err => console.log('Erreur reprise musique:', err));
  } else if (musicEnabled && !musicAudio) {
    playRandomMusic();
  }
}

// Fonction pour arrÃªter la musique
function stopMusic() {
  if (musicAudio) {
    musicAudio.pause();
    musicAudio.currentTime = 0;
  }
  if (rainMusicAudio) {
    rainMusicAudio.pause();
    rainMusicAudio.currentTime = 0;
  }
}

// Boutons de contrÃ´le audio
const musicBtn = document.getElementById('musicBtn');
const sfxBtn = document.getElementById('sfxBtn');

musicBtn.addEventListener('click', () => {
  musicEnabled = !musicEnabled;
  musicBtn.classList.toggle('muted', !musicEnabled);
  musicBtn.textContent = musicEnabled ? 'â™«' : 'âœ•';
  if (musicEnabled && state === 'playing') {
    playRandomMusic();
  } else {
    stopMusic();
  }
});

sfxBtn.addEventListener('click', () => {
  sfxEnabled = !sfxEnabled;
  sfxBtn.classList.toggle('muted', !sfxEnabled);
  sfxBtn.textContent = sfxEnabled ? 'â™ª' : 'âœ•';
});

// Fonction pour jouer un son simple avec Web Audio API
function playSound(type) {
  if (!sfxEnabled) return;
  
  const now = audioContext.currentTime;
  
  switch(type) {
    case 'shoot': // Tir - plok plouf doux
      {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        // Filtre pour adoucir le son
        const filter = audioContext.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.value = 800;
        filter.Q.value = 1;
        
        oscillator.connect(filter);
        filter.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // Son de goutte : frÃ©quence qui descend rapidement
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(600, now);
        oscillator.frequency.exponentialRampToValueAtTime(200, now + 0.08);
        
        // Enveloppe douce et plus faible
        gainNode.gain.setValueAtTime(0.08, now); // RÃ©duit de 0.15 Ã  0.08
        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.08);
        
        oscillator.start(now);
        oscillator.stop(now + 0.08);
      }
      break;
      
    case 'hit': // Nuage dÃ©truit - souffle de vent plus long
      {
        const bufferSize = audioContext.sampleRate * 0.25; // 250ms
        const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
        const output = buffer.getChannelData(0);
        
        // Bruit blanc
        for (let i = 0; i < bufferSize; i++) {
          output[i] = Math.random() * 2 - 1;
        }
        
        const noise = audioContext.createBufferSource();
        noise.buffer = buffer;
        
        // Filtre passe-bande pour un son de vent doux
        const filter = audioContext.createBiquadFilter();
        filter.type = 'bandpass';
        filter.frequency.value = 800;
        filter.Q.value = 1;
        
        const gainNode = audioContext.createGain();
        gainNode.gain.setValueAtTime(0.25, now);
        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.25);
        
        noise.connect(filter);
        filter.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        noise.start(now);
        noise.stop(now + 0.25);
      }
      break;
      
    case 'powerup': // Power-up collectÃ©
      {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(400, now);
        oscillator.frequency.setValueAtTime(600, now + 0.05);
        oscillator.frequency.setValueAtTime(800, now + 0.1);
        gainNode.gain.setValueAtTime(0.3, now);
        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
        oscillator.start(now);
        oscillator.stop(now + 0.15);
      }
      break;
      
    case 'damage': // DÃ©gÃ¢t reÃ§u
      {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(200, now);
        oscillator.frequency.exponentialRampToValueAtTime(50, now + 0.3);
        oscillator.type = 'sawtooth';
        gainNode.gain.setValueAtTime(0.5, now);
        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
        oscillator.start(now);
        oscillator.stop(now + 0.3);
      }
      break;
      
    case 'levelup': // Passage de niveau
      {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(400, now);
        oscillator.frequency.setValueAtTime(500, now + 0.1);
        oscillator.frequency.setValueAtTime(600, now + 0.2);
        oscillator.frequency.setValueAtTime(800, now + 0.3);
        gainNode.gain.setValueAtTime(0.4, now);
        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
        oscillator.start(now);
        oscillator.stop(now + 0.4);
      }
      break;
      
    case 'shockwave': // Onde de choc
      {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(100, now);
        oscillator.frequency.exponentialRampToValueAtTime(1000, now + 0.5);
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.6, now);
        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
        oscillator.start(now);
        oscillator.stop(now + 0.5);
      }
      break;
      
    case 'rainbow': // Nuage touche bouclier arc-en-ciel - "batsheuu" doux et long
      {
        // CrÃ©er un buffer de bruit rose (plus doux que blanc)
        const bufferSize = audioContext.sampleRate * 0.4; // 400ms - long et relaxant
        const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
        const output = buffer.getChannelData(0);
        
        // GÃ©nÃ©rer du bruit rose filtrÃ© (plus naturel et doux)
        let b0 = 0, b1 = 0, b2 = 0, b3 = 0, b4 = 0, b5 = 0, b6 = 0;
        for (let i = 0; i < bufferSize; i++) {
          const white = Math.random() * 2 - 1;
          b0 = 0.99886 * b0 + white * 0.0555179;
          b1 = 0.99332 * b1 + white * 0.0750759;
          b2 = 0.96900 * b2 + white * 0.1538520;
          b3 = 0.86650 * b3 + white * 0.3104856;
          b4 = 0.55000 * b4 + white * 0.5329522;
          b5 = -0.7616 * b5 - white * 0.0168980;
          output[i] = (b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362) * 0.11;
          b6 = white * 0.115926;
        }
        
        const noise = audioContext.createBufferSource();
        noise.buffer = buffer;
        
        // Filtre pour un son magique et doux
        const filter = audioContext.createBiquadFilter();
        filter.type = 'bandpass';
        filter.frequency.value = 1200; // FrÃ©quence moyenne douce
        filter.Q.value = 2; // RÃ©sonance pour effet magique
        
        const gainNode = audioContext.createGain();
        gainNode.gain.setValueAtTime(0.2, now);
        gainNode.gain.linearRampToValueAtTime(0.25, now + 0.1); // Monte lÃ©gÃ¨rement
        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4); // Descend doucement
        
        noise.connect(filter);
        filter.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        noise.start(now);
        noise.stop(now + 0.4);
      }
      break;
      
    case 'bonus': // Collecte d'objet bonus - son joyeux
      {
        // CrÃ©er deux oscillateurs pour un son riche
        const osc1 = audioContext.createOscillator();
        const osc2 = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        // Mixer les deux oscillateurs
        const merger = audioContext.createChannelMerger(2);
        osc1.connect(merger, 0, 0);
        osc2.connect(merger, 0, 1);
        merger.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // Son brillant qui monte
        osc1.type = 'sine';
        osc2.type = 'sine';
        osc1.frequency.setValueAtTime(523, now); // Do
        osc2.frequency.setValueAtTime(659, now); // Mi
        osc1.frequency.setValueAtTime(784, now + 0.08); // Sol
        osc2.frequency.setValueAtTime(1047, now + 0.08); // Do aigu
        
        // Enveloppe joyeuse
        gainNode.gain.setValueAtTime(0.25, now);
        gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
        
        osc1.start(now);
        osc2.start(now);
        osc1.stop(now + 0.15);
        osc2.stop(now + 0.15);
      }
      break;
  }
}

// ============================================
// ï¿½ğŸ® CODE DU JEU
// ============================================
const c=document.getElementById('gameCanvas'),ctx=c.getContext('2d'),scoreEl=document.getElementById('score'),cloudsEl=document.getElementById('clouds'),levelEl=document.getElementById('level'),livesEl=document.getElementById('lives'),starStockEl=document.getElementById('starStock'),messageEl=document.getElementById('message'),startBtn=document.getElementById('startButton'),sunEl=document.getElementById('sun');

let state='start',score=0,cloudsCleared=0,level=1,lives=3,lastTime=0,umbrella=false,speed=false,multi=false;
let lastSavedCloudsCount=0;

const player={x:c.width/2,y:c.height-120,w:40,h:30,s:5};

let bullets=[],clouds=[],rain=[],particles=[],powerUps=[],hearts=[],touchX=null,touchY=null,shooting=false,lastShot=0,bonusItems=[];
let isBonusLevel=false,bonusItemsCollected=0,bonusItemsTarget=20,bonusLevelNumber=0;
let cloudKillCount=0,fallingPowerUps=[],collectedStar=false,lastClickTime=0,shockwaves=[];
let umbrellaEndTime=0,speedEndTime=0,multiEndTime=0;

// Nuages de fond dÃ©coratifs
let backgroundClouds = [];

// Gouttes de pluie dÃ©coratives pour le niveau 7
let decorativeRain = [];

// Fonction pour crÃ©er une goutte de pluie dÃ©corative
function decorativeRainDrop() {
  return {
    x: Math.random() * c.width,
    y: -Math.random() * c.height,
    speed: 5 + Math.random() * 3,
    length: 10 + Math.random() * 10,
    opacity: 0.3 + Math.random() * 0.4
  };
}

// Fonction pour dessiner une goutte de pluie dÃ©corative
function drawDecorativeRain(drop) {
  ctx.strokeStyle = `rgba(173, 216, 230, ${drop.opacity})`;
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(drop.x, drop.y);
  ctx.lineTo(drop.x, drop.y + drop.length);
  ctx.stroke();
}

// Fonction pour crÃ©er un power-up tombant du ciel
function createFallingPowerUp(type) {
  return {
    type: type, // 'heart', 'rainbow', 'star'
    x: 50 + Math.random() * (c.width - 100),
    y: -40,
    w: 30,
    h: 30,
    speed: 2,
    angle: 0
  };
}

// Fonction pour dessiner les power-ups
function drawPowerUp(powerup) {
  ctx.save();
  ctx.translate(powerup.x + powerup.w/2, powerup.y + powerup.h/2);
  ctx.rotate(powerup.angle || 0);
  
  // Afficher l'icÃ´ne correspondante
  const fontSize = powerup.w || 25; // Adapter la taille Ã  la largeur du power-up
  ctx.font = `${fontSize}px Arial`;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  
  if(powerup.type === 'heart') {
    ctx.fillText('ğŸ’–', 0, 0);
  } else if(powerup.type === 'rainbow') {
    ctx.fillText('ğŸŒˆ', 0, 0);
  } else if(powerup.type === 'star') {
    ctx.fillText('â­', 0, 0);
  } else if(powerup.type === 'umbrella') {
    ctx.fillText('â˜‚ï¸', 0, 0);
  } else if(powerup.type === 'speed') {
    ctx.fillText('âš¡', 0, 0);
  } else if(powerup.type === 'multishot') {
    ctx.fillText('ğŸ”«', 0, 0);
  }
  
  ctx.restore();
}

// Fonction pour crÃ©er une onde de choc
function createShockwave(x, y) {
  return {
    x: x,
    y: y,
    radius: 0,
    maxRadius: Math.max(c.width, c.height),
    opacity: 1,
    speed: 15
  };
}

// Fonction pour dessiner une onde de choc
function drawShockwave(wave) {
  ctx.save();
  ctx.strokeStyle = `rgba(255, 215, 0, ${wave.opacity})`;
  ctx.lineWidth = 4;
  ctx.shadowBlur = 20;
  ctx.shadowColor = 'rgba(255, 215, 0, 0.8)';
  ctx.beginPath();
  ctx.arc(wave.x, wave.y, wave.radius, 0, Math.PI * 2);
  ctx.stroke();
  
  // DeuxiÃ¨me cercle intÃ©rieur
  ctx.strokeStyle = `rgba(255, 255, 255, ${wave.opacity * 0.6})`;
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.arc(wave.x, wave.y, wave.radius * 0.8, 0, Math.PI * 2);
  ctx.stroke();
  ctx.restore();
}

// Fonction pour adapter le canvas au format portrait mobile
function resizeCanvas() {
  const container = document.getElementById('gameContainer');
  const containerWidth = container.clientWidth;
  const containerHeight = container.clientHeight;
  
  // Format mobile HD portrait optimisÃ© (9:16 ou similaire)
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  
  if(isMobile || containerWidth < containerHeight) {
    // Mode portrait mobile : utiliser tout l'Ã©cran disponible
    const targetWidth = Math.min(containerWidth, 480);  // Max 480px de large
    const targetHeight = containerHeight;
    
    c.width = targetWidth;
    c.height = targetHeight;
  } else {
    // Mode desktop : format 9:16
    c.width = containerWidth;
    c.height = containerHeight;
  }
  
  player.x = c.width / 2;
  player.y = c.height - 120;
  
  // RecrÃ©er les nuages de fond avec les nouvelles dimensions
  backgroundClouds = [];
  for(let i = 0; i < 8; i++) {
    backgroundClouds.push(createBackgroundCloud());
  }
}

function createBackgroundCloud() {
  return {
    x: Math.random() * c.width,
    y: Math.random() * c.height * 0.6,
    size: 15 + Math.random() * 25,
    speed: 0.05 + Math.random() * 0.15,
    opacity: 0.3 + Math.random() * 0.3
  };
}

resizeCanvas();


function drawBackgroundCloud(bgCloud) {
  ctx.globalAlpha = bgCloud.opacity;
  ctx.fillStyle = '#ffffff';
  ctx.beginPath();
  ctx.arc(bgCloud.x, bgCloud.y, bgCloud.size, 0, Math.PI * 2);
  ctx.arc(bgCloud.x + bgCloud.size * 0.7, bgCloud.y - bgCloud.size * 0.3, bgCloud.size * 0.8, 0, Math.PI * 2);
  ctx.arc(bgCloud.x + bgCloud.size * 1.4, bgCloud.y, bgCloud.size * 0.9, 0, Math.PI * 2);
  ctx.fill();
  ctx.globalAlpha = 1;
}

function updateBackgroundClouds() {
  backgroundClouds.forEach(bgCloud => {
    bgCloud.x += bgCloud.speed;
    if(bgCloud.x > c.width + bgCloud.size * 2) {
      bgCloud.x = -bgCloud.size * 2;
      bgCloud.y = Math.random() * c.height * 0.6;
    }
  });
}

function cloud(){const shoot=Math.random()>(1-currentLevelConfig.shootingClouds);return{x:Math.random()*(c.width-55),y:-40,w:52,h:32,s:currentLevelConfig.cloudSpeed.min+Math.random()*(currentLevelConfig.cloudSpeed.max-currentLevelConfig.cloudSpeed.min),c:shoot?'#7f8c8d':'#95a5a6',shoot:shoot,lastShot:Date.now(),delay:2000+Math.random()*3000};}

function bonusItem(){
  const types=[
    {name:'heart',icon:'â¤ï¸',points:500,color:'#e74c3c'},
    {name:'star',icon:'â­',points:300,color:'#f1c40f'},
    {name:'cross',icon:'âœï¸',points:1000,color:'#ecf0f1'},
    {name:'coin',icon:'ğŸ’°',points:-200,color:'#95a5a6'},
    {name:'rainbow',icon:'ğŸŒˆ',points:1500,color:'#9b59b6'}
  ];
  const type=types[Math.floor(Math.random()*types.length)];
  return{
    x:Math.random()*(c.width-40),
    y:-40,
    w:35,
    h:35,
    s:2+Math.random()*1.5,
    type:type.name,
    icon:type.icon,
    points:type.points,
    color:type.color,
    rotation:0,
    rotSpeed:(Math.random()-0.5)*0.1
  };
}

function rainDrop(x,y){return{x:x,y:y,w:3,h:8,s:currentLevelConfig.rainSpeed.min+Math.random()*(currentLevelConfig.rainSpeed.max-currentLevelConfig.rainSpeed.min),c:'#3498db'};}

function powerUp(x,y){const types=['umbrella','speed','multishot'],type=types[Math.floor(Math.random()*types.length)],colors={umbrella:'#e74c3c',speed:'#9b59b6',multishot:'#f39c12'};return{x:x,y:y,w:25,h:25,s:2,type:type,c:colors[type]};}

function bullet(x,y,color,width){return{x:x,y:y,w:width||4,h:12,s:8,c:color||'#f1c40f'};}

function heart(){return{x:player.x+18+Math.random()*8,y:player.y+10+Math.random()*5,vx:(Math.random()-0.5)*1.5,vy:-2.5-Math.random()*1.2,size:12+Math.random()*6,life:1,decay:0.006,c:'#e74c3c',rot:0,rotS:(Math.random()-0.5)*0.1};}

function particle(x,y){return{x:x,y:y,vx:(Math.random()-0.5)*6,vy:(Math.random()-0.5)*6,life:1,decay:0.02,c:`hsl(${45+Math.random()*30},80%,70%)`};}

function drawBonusItem(item){
  ctx.save();
  ctx.translate(item.x+item.w/2,item.y+item.h/2);
  ctx.rotate(item.rotation);
  ctx.shadowBlur=15;
  ctx.shadowColor=item.color;
  ctx.font='30px Arial';
  ctx.textAlign='center';
  ctx.textBaseline='middle';
  ctx.fillText(item.icon,0,0);
  ctx.shadowBlur=0;
  ctx.restore();
}

function drawPlayer(){
let glow='#f1c40f',intensity=20;
let haloColor='rgba(241,196,15,0.2)';
let haloGlow='#f1c40f';

if(umbrella){
  glow='#e74c3c';
  intensity=30;
  haloColor='rgba(231,76,60,0.2)';
  haloGlow='#e74c3c';
}else if(speed){
  glow='#9b59b6';
  intensity=25;
  haloColor='rgba(155,89,182,0.2)';
  haloGlow='#9b59b6';
}else if(multi){
  glow='#f39c12';
  intensity=23;
  haloColor='rgba(243,156,18,0.2)';
  haloGlow='#f39c12';
}else if(shooting){
  // Changement de couleur quand on tire
  glow='#3498db';
  intensity=25;
  haloColor='rgba(52,152,219,0.3)';
  haloGlow='#3498db';
}

ctx.shadowBlur=30;ctx.shadowColor=haloGlow;ctx.fillStyle=haloColor;ctx.beginPath();ctx.arc(player.x+20,player.y+15,40,0,Math.PI*2);ctx.fill();

ctx.shadowBlur=intensity;ctx.shadowColor=glow;ctx.fillStyle='#ffffff';

ctx.strokeStyle='#2c3e50';ctx.lineWidth=1;

const beat=Math.sin(Date.now()*(speed?0.025:0.015))*2;

ctx.beginPath();ctx.moveTo(player.x+20,player.y+8);ctx.lineTo(player.x+15,player.y+22);ctx.lineTo(player.x+25,player.y+22);ctx.closePath();ctx.fill();ctx.stroke();

ctx.beginPath();ctx.moveTo(player.x+15,player.y+12);ctx.lineTo(player.x+2,player.y+8+beat);ctx.lineTo(player.x+18,player.y+25);ctx.closePath();ctx.fill();ctx.stroke();

ctx.beginPath();ctx.moveTo(player.x+25,player.y+12);ctx.lineTo(player.x+38,player.y+8-beat);ctx.lineTo(player.x+22,player.y+25);ctx.closePath();ctx.fill();ctx.stroke();

ctx.beginPath();ctx.moveTo(player.x+20,player.y+22);ctx.lineTo(player.x+18,player.y+30);ctx.lineTo(player.x+22,player.y+30);ctx.closePath();ctx.fill();ctx.stroke();

ctx.shadowBlur=40;ctx.shadowColor='rgba(241,196,15,0.4)';ctx.fillStyle='rgba(255,255,255,0.1)';ctx.beginPath();ctx.arc(player.x+20,player.y+15,50,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;

if(umbrella){
  // Dessiner l'arc-en-ciel au-dessus de la colombe
  ctx.save();
  ctx.lineWidth = 3;
  const rainbowColors = ['#ff0000', '#ff7f00', '#ffff00', '#00ff00', '#0000ff', '#4b0082', '#9400d3'];
  const centerX = player.x + 20;
  const centerY = player.y - 10;
  
  for(let i = 0; i < rainbowColors.length; i++) {
    ctx.strokeStyle = rainbowColors[i];
    ctx.shadowBlur = 10;
    ctx.shadowColor = rainbowColors[i];
    ctx.beginPath();
    ctx.arc(centerX, centerY, 25 - i * 3, 0, Math.PI, true);
    ctx.stroke();
  }
  ctx.shadowBlur = 0;
  ctx.restore();
  
  // Parapluie en-dessous de l'arc-en-ciel
  ctx.strokeStyle='rgba(231,76,60,0.7)';
  ctx.lineWidth=2;
  ctx.shadowBlur=8;
  ctx.shadowColor='#e74c3c';
  ctx.beginPath();
  ctx.arc(player.x+20,player.y-5,15,0,Math.PI,true);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(player.x+20,player.y-5);
  ctx.lineTo(player.x+20,player.y+8);
  ctx.stroke();
  ctx.shadowBlur=0;
}

// Afficher le compteur d'Ã©toiles au-dessus de la colombe
if(starCount > 0){
  ctx.save();
  const starY = player.y - 25 + Math.sin(Date.now() * 0.005) * 3;
  ctx.shadowBlur = 15;
  ctx.shadowColor = '#ffd700';
  ctx.fillStyle = '#ffd700';
  ctx.strokeStyle = '#ffaa00';
  ctx.lineWidth = 2;
  ctx.beginPath();
  for(let i = 0; i < 5; i++) {
    const angle = (i * 4 * Math.PI / 5) - Math.PI / 2;
    const x = player.x + 20 + Math.cos(angle) * 12;
    const y = starY + Math.sin(angle) * 12;
    if(i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.closePath();
  ctx.fill();
  ctx.stroke();
  
  // Afficher le compteur Ã  cÃ´tÃ© de l'Ã©toile avec fade rapide
  const timeSinceChange = Date.now() - lastStarChangeTime;
  const fadeTime = 1500; // DisparaÃ®t aprÃ¨s 1.5 secondes
  if(timeSinceChange < fadeTime) {
    const opacity = Math.max(0, 1 - (timeSinceChange / fadeTime));
    ctx.globalAlpha = opacity;
    ctx.font = 'bold 16px Arial';
    ctx.fillStyle = '#ffffff';
    ctx.strokeStyle = '#000000';
    ctx.lineWidth = 3;
    ctx.strokeText(`x${starCount}`, player.x + 35, starY + 5);
    ctx.fillText(`x${starCount}`, player.x + 35, starY + 5);
    ctx.globalAlpha = 1;
  }
  
  ctx.shadowBlur = 0;
  ctx.restore();
}
}

function drawCloud(cl){ctx.fillStyle=cl.c;ctx.shadowBlur=3;ctx.shadowColor=cl.c;ctx.beginPath();ctx.arc(cl.x+10,cl.y+15,10,0,Math.PI*2);ctx.arc(cl.x+25,cl.y+10,12,0,Math.PI*2);ctx.arc(cl.x+40,cl.y+15,10,0,Math.PI*2);ctx.arc(cl.x+20,cl.y+20,8,0,Math.PI*2);ctx.fill();if(cl.shoot){ctx.fillStyle='#34495e';ctx.beginPath();ctx.arc(cl.x+25,cl.y+12,3,0,Math.PI*2);ctx.fill();}ctx.shadowBlur=0;}

function drawRain(r){ctx.fillStyle=r.c;ctx.shadowBlur=2;ctx.shadowColor=r.c;ctx.beginPath();ctx.ellipse(r.x,r.y,2,4,0,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;}

function drawPowerUp(p){ctx.strokeStyle=p.c;ctx.fillStyle=p.c;ctx.lineWidth=2;if(p.type==='umbrella'){ctx.beginPath();ctx.arc(p.x+12,p.y+8,12,0,Math.PI,true);ctx.stroke();ctx.beginPath();ctx.moveTo(p.x+12,p.y+8);ctx.lineTo(p.x+12,p.y+20);ctx.stroke();}else if(p.type==='speed'){ctx.beginPath();ctx.moveTo(p.x+8,p.y+2);ctx.lineTo(p.x+12,p.y+2);ctx.lineTo(p.x+6,p.y+12);ctx.lineTo(p.x+10,p.y+12);ctx.lineTo(p.x+4,p.y+22);ctx.lineTo(p.x+16,p.y+10);ctx.lineTo(p.x+12,p.y+10);ctx.lineTo(p.x+18,p.y+2);ctx.closePath();ctx.fill();}else{for(let i=0;i<3;i++){const o=i*6;ctx.beginPath();ctx.arc(p.x+6+o,p.y+12,4,0,Math.PI*2);ctx.fill();}}}

function drawBullet(b){ctx.fillStyle=b.c;ctx.shadowBlur=8;ctx.shadowColor=b.c;ctx.fillRect(b.x,b.y,b.w,b.h);ctx.shadowBlur=0;}

function drawHeart(h){ctx.save();ctx.globalAlpha=h.life;ctx.translate(h.x,h.y);ctx.rotate(h.rot);ctx.fillStyle=h.c;ctx.shadowBlur=8;ctx.shadowColor=h.c;const s=h.size;ctx.beginPath();ctx.arc(-s/4,-s/4,s/4,0,Math.PI*2);ctx.arc(s/4,-s/4,s/4,0,Math.PI*2);ctx.moveTo(0,s/4);ctx.lineTo(-s/2,-s/8);ctx.lineTo(s/2,-s/8);ctx.closePath();ctx.fill();ctx.shadowBlur=0;ctx.restore();}

function drawParticle(p){ctx.globalAlpha=p.life;ctx.fillStyle=p.c;ctx.shadowBlur=5;ctx.shadowColor=p.c;ctx.fillRect(p.x,p.y,3,3);ctx.shadowBlur=0;ctx.globalAlpha=1;}

function setSun(mood){sunEl.className=`sun ${mood}`;}

// Fonction de collision avec marge de prÃ©cision
function hit(a,b,margin=0){
  const m = margin || 0;
  return a.x+m < b.x+b.w-m && 
         a.x+a.w-m > b.x+m && 
         a.y+m < b.y+b.h-m && 
         a.y+a.h-m > b.y+m;
}

// Fonction de collision prÃ©cise pour les nuages (avec marge rÃ©duite)
function hitCloud(player,cloud){
  const margin = 2; // Marge rÃ©duite Ã  2px pour meilleure dÃ©tection
  return player.x+margin < cloud.x+cloud.w-margin && 
         player.x+player.w-margin > cloud.x+margin && 
         player.y+margin < cloud.y+cloud.h-margin && 
         player.y+player.h-margin > cloud.y+margin;
}

function msg(text){messageEl.textContent=text;messageEl.style.opacity='1';const time=Math.max(3000,Math.min(3000+text.length*50,6000));setTimeout(()=>messageEl.style.opacity='0',time);}

// Popup Ã©lÃ©gant dans le canvas (remplace alert)
function showPopup(message, icon = 'âœ¨', type = 'info') {
  const colors = {
    success: { bg: 'rgba(46,204,113,0.95)', border: '#27ae60' },
    error: { bg: 'rgba(231,76,60,0.95)', border: '#c0392b' },
    info: { bg: 'rgba(52,152,219,0.95)', border: '#2980b9' },
    warning: { bg: 'rgba(241,196,15,0.95)', border: '#f39c12' }
  };
  
  const color = colors[type] || colors.info;
  
  const popup = document.createElement('div');
  popup.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.8);
    background: ${color.bg};
    color: white;
    padding: 30px 40px;
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    z-index: 10000;
    text-align: center;
    font-size: 16px;
    line-height: 1.6;
    max-width: 400px;
    border: 3px solid ${color.border};
    animation: popupEnter 0.3s ease-out forwards;
  `;
  
  popup.innerHTML = `
    <div style="font-size: 48px; margin-bottom: 15px;">${icon}</div>
    <div style="white-space: pre-line; font-weight: 500;">${message}</div>
    <button onclick="this.parentElement.remove()" style="
      margin-top: 20px;
      padding: 12px 30px;
      background: rgba(255,255,255,0.2);
      border: 2px solid white;
      border-radius: 10px;
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
      OK
    </button>
  `;
  
  // Ajouter l'animation CSS
  if (!document.getElementById('popupStyle')) {
    const style = document.createElement('style');
    style.id = 'popupStyle';
    style.textContent = `
      @keyframes popupEnter {
        from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
        to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      }
    `;
    document.head.appendChild(style);
  }
  
  document.getElementById('gameContainer').appendChild(popup);
  
  // Auto-fermeture aprÃ¨s 5 secondes
  setTimeout(() => {
    if (popup.parentElement) popup.remove();
  }, 5000);
}

let gameStartTime = 0; // Pour mesurer le temps de jeu

function restart(){
  // Sauvegarder les stats de la partie prÃ©cÃ©dente si elle existait
  if (gameStartTime > 0) {
    const survivalTime = Date.now() - gameStartTime;
    saveGameEnd(score, level, cloudsCleared, survivalTime);
  }
  
  // NE PAS rÃ©initialiser starCount pour conserver le stock entre les parties
  score=0;cloudsCleared=0;lives=3;bullets=[];clouds=[];rain=[];particles=[];powerUps=[];hearts=[];umbrella=false;speed=false;multi=false;totalScore=0;cloudsInLevel=0;bonusItems=[];isBonusLevel=false;bonusItemsCollected=0;bonusLevelNumber=0;fallingPowerUps=[];cloudKillCount=0;collectedStar=false;shockwaves=[];umbrellaEndTime=0;speedEndTime=0;multiEndTime=0;lastSavedCloudsCount=0;
  gameStartTime = Date.now(); // Nouveau dÃ©part
  
  // Reprendre au niveau sauvegardÃ©
  const savedLevelIndex = Math.max(0, (gameData.highestLevelReached || 1) - 1);
  currentLevelIndex = Math.min(savedLevelIndex, LEVELS_CONFIG.length - 1);
  level = gameData.highestLevelReached || 1;
  
  startLevel(currentLevelIndex);
  msg(t('messages.restart'));
  
  // DÃ©marrer la musique gospel
  if (musicEnabled) {
    playRandomMusic();
  }
}

function startBonusLevel(){
  // Supprimer tous les anciens menus de bonus qui pourraient traÃ®ner
  const oldMenus = document.querySelectorAll('[data-bonus-menu]');
  oldMenus.forEach(menu => menu.remove());
  
  isBonusLevel=true;
  bonusItemsCollected=0;
  bonusItemsTarget=20;
  clouds=[];
  rain=[];
  bullets=[];
  bonusItems=[];
  setSun('happy');
  
  // Messages philosophiques selon le numÃ©ro de bonus
  const bonusMessages = [
    "L'amour de l'argent crÃ©e bien des maux, mais utilisÃ© avec sagesse et amour il est une grande source de bÃ©nÃ©diction.",
    "Apprends Ã  aimer ce que tu as dÃ©jÃ  et ne soupire pas jalousement sur ce qui n'est pas Ã  toi.",
    "La vraie richesse est dans le cÅ“ur, ta force est que tu es unique, plus prÃ©cieux que l'or et l'argent.",
    "LibÃ¨re-toi de l'esclavage matÃ©riel, sois vraiment libre, sois un bon gestionnaire sage."
  ];
  
  const message = bonusMessages[bonusLevelNumber - 1] || bonusMessages[0];
  
  const bonusDiv=document.createElement('div');
  bonusDiv.setAttribute('data-bonus-menu', 'start');
  bonusDiv.style.cssText=`
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    width:90%;
    max-width:500px;
    background:rgba(255,255,255,0.95);
    backdrop-filter:blur(20px);
    color:#1a1a2e;
    padding:30px;
    border-radius:25px;
    text-align:center;
    z-index:450;
    box-shadow:0 20px 60px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.3) inset;
    animation:fadeIn 0.5s ease-in;
    border:2px solid rgba(255,255,255,0.5);
  `;
  
  bonusDiv.innerHTML=`
    <div style="display:inline-block;padding:8px 20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:20px;margin-bottom:15px;">
      <h2 style="font-size:22px;margin:0;color:white;font-weight:800;letter-spacing:1px;">ğŸ NIVEAU BONUS ${bonusLevelNumber}</h2>
    </div>
    <p style="font-size:12px;font-style:italic;margin-bottom:18px;color:#4a4a68;line-height:1.5;padding:0 10px;">
      "${message}"
    </p>
    <div style="background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);padding:15px;border-radius:15px;margin-bottom:15px;font-size:13px;line-height:1.8;color:#2d3436;">
      <strong style="display:block;margin-bottom:8px;font-size:14px;color:#1a1a2e;">âœ¨ Collecte les bÃ©nÃ©dictions :</strong>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;text-align:left;">
        <div>â­ Ã‰toile <span style="color:#f39c12;font-weight:bold;">+300</span></div>
        <div>â¤ï¸ CÅ“ur <span style="color:#e74c3c;font-weight:bold;">+500</span></div>
        <div>âœï¸ Croix <span style="color:#3498db;font-weight:bold;">+1000</span></div>
        <div>ğŸŒˆ Arc-en-ciel <span style="color:#9b59b6;font-weight:bold;">+1500</span></div>
      </div>
      <div style="margin-top:8px;text-align:center;color:#e74c3c;font-weight:bold;background:rgba(231,76,60,0.1);padding:6px;border-radius:8px;">
        ğŸ’° PiÃ¨ce = -200 pts (PIÃˆGE !)
      </div>
    </div>
    <p style="font-size:14px;margin-bottom:20px;font-weight:600;color:#2d3436;background:rgba(52,152,219,0.1);padding:10px;border-radius:10px;">
      ğŸ¯ Objectif : <span style="color:#3498db;font-size:16px;">${bonusItemsTarget}</span> objets
    </p>
    <button onclick="this.parentElement.remove();state='playing';" style="
      padding:14px 40px;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:white;
      border:none;
      border-radius:50px;
      font-size:16px;
      font-weight:bold;
      cursor:pointer;
      box-shadow:0 8px 20px rgba(102,126,234,0.4);
      transition:all 0.3s;
      letter-spacing:1px;
      text-transform:uppercase;
    " onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 12px 25px rgba(102,126,234,0.5)'" onmouseout="this.style.transform='';this.style.boxShadow='0 8px 20px rgba(102,126,234,0.4)'">âœ¨ Commencer</button>
  `;
  
  document.getElementById('gameContainer').appendChild(bonusDiv);
  state='levelComplete';
}

function endBonusLevel(){
  // Supprimer tous les menus de bonus
  const oldMenus = document.querySelectorAll('[data-bonus-menu]');
  oldMenus.forEach(menu => menu.remove());
  
  isBonusLevel=false;
  bonusItems=[];
  
  const bonusScore=bonusItemsCollected*100;
  
  // Sauvegarder les stats du bonus
  if(bonusLevelNumber > 0 && bonusLevelNumber <= 4){
    gameData.bonusLevels.completed[bonusLevelNumber-1] = true;
    if(bonusScore > gameData.bonusLevels.bestScores[bonusLevelNumber-1]){
      gameData.bonusLevels.bestScores[bonusLevelNumber-1] = bonusScore;
    }
    gameData.bonusLevels.totalItemsCollected += bonusItemsCollected;
    saveGameData();
  }
  
  const endDiv=document.createElement('div');
  endDiv.setAttribute('data-bonus-menu', 'end');
  endDiv.style.cssText=`
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    width:90%;
    max-width:500px;
    background:rgba(255,255,255,0.95);
    backdrop-filter:blur(20px);
    color:#1a1a2e;
    padding:30px 25px;
    border-radius:25px;
    text-align:center;
    z-index:450;
    box-shadow:0 20px 60px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.3) inset;
    border:2px solid rgba(255,255,255,0.5);
  `;
  
  endDiv.innerHTML=`
    <div style="display:inline-block;padding:10px 25px;background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);border-radius:20px;margin-bottom:15px;">
      <h2 style="font-size:20px;margin:0;color:white;font-weight:800;letter-spacing:1px;">ğŸ‰ BONUS TERMINÃ‰</h2>
    </div>
    <p style="font-size:48px;margin:15px 0;filter:drop-shadow(0 4px 8px rgba(0,0,0,0.2));">ğŸ†</p>
    <div style="background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);padding:15px;border-radius:15px;margin-bottom:15px;">
      <p style="font-size:15px;margin:0 0 10px 0;line-height:1.4;color:#2d3436;">
        <strong style="font-size:16px;">Objets collectÃ©s</strong><br>
        <span style="font-size:28px;color:#3498db;font-weight:800;">${bonusItemsCollected}</span>
        <span style="font-size:20px;color:#95a5a6;"> / ${bonusItemsTarget}</span>
      </p>
    </div>
    <div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:15px;border-radius:15px;margin-bottom:20px;">
      <p style="font-size:14px;margin:0 0 5px 0;color:rgba(255,255,255,0.9);letter-spacing:1px;">SCORE BONUS</p>
      <p style="font-size:32px;margin:0;color:white;font-weight:800;">+${bonusScore}</p>
    </div>
    <button onclick="this.parentElement.remove();state='playing';" style="
      padding:14px 40px;
      background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);
      color:white;
      border:none;
      border-radius:50px;
      font-size:16px;
      font-weight:bold;
      cursor:pointer;
      box-shadow:0 8px 20px rgba(17,153,142,0.4);
      transition:all 0.3s;
      letter-spacing:1px;
      text-transform:uppercase;
    " onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 12px 25px rgba(17,153,142,0.5)'" onmouseout="this.style.transform='';this.style.boxShadow='0 8px 20px rgba(17,153,142,0.4)'">âœ¨ Continuer</button>
  `;
  
  document.getElementById('gameContainer').appendChild(endDiv);
  state='levelComplete';
  
  score+=bonusScore;
  saveProgress(level,score,cloudsCleared);
  
  // Reprendre le jeu normal aprÃ¨s le bonus
  setTimeout(() => {
    const continueBtn = endDiv.querySelector('button');
    if(continueBtn) {
      continueBtn.onclick = () => {
        endDiv.remove();
        completeLevel();
      };
    }
  }, 100);
}

function update(dt){
if(state!=='playing')return;

// Mettre Ã  jour les nuages de fond
updateBackgroundClouds();

// Mettre Ã  jour la pluie dÃ©corative (niveau 7)
decorativeRain.forEach((drop, i) => {
  drop.y += drop.speed;
  if (drop.y > c.height) {
    decorativeRain[i] = decorativeRainDrop();
  }
});

// Mettre Ã  jour les power-ups qui tombent
for(let i = fallingPowerUps.length - 1; i >= 0; i--) {
  const pu = fallingPowerUps[i];
  pu.y += pu.speed;
  pu.angle += 0.05;
  
  // VÃ©rifier la collision avec le joueur
  if(hitCloud(player, pu)) {
    // Activer l'effet du power-up
    if(pu.type === 'heart') {
      lives = Math.min(5, lives + 1);
      playSound('powerup');
      msg(t('powerups.heart'));
      fallingPowerUps.splice(i, 1);
    } else if(pu.type === 'rainbow') {
      umbrella = true;
      // Additionner le temps si dÃ©jÃ  actif, sinon nouveau timer
      const remainingUmbrella = umbrella && umbrellaEndTime > Date.now() ? umbrellaEndTime - Date.now() : 0;
      umbrellaEndTime = Date.now() + remainingUmbrella + 8000;
      
      multi = true;
      const remainingMulti = multi && multiEndTime > Date.now() ? multiEndTime - Date.now() : 0;
      multiEndTime = Date.now() + remainingMulti + 8000;
      
      playSound('powerup');
      msg(t('powerups.rainbow'));
      fallingPowerUps.splice(i, 1);
    } else if(pu.type === 'star') {
      // Ajouter une Ã©toile au compteur
      starCount++;
      lastStarChangeTime = Date.now(); // Marquer le moment du changement
      playSound('powerup');
      msg(`â­ Ã‰toile collectÃ©e ! (${starCount} en stock) - Double-clic pour onde de choc !`);
      fallingPowerUps.splice(i, 1);
    }
  } else if(pu.y > c.height) {
    fallingPowerUps.splice(i, 1);
  }
}

if(touchX!==null&&touchY!==null){const currentSpeed=speed?player.s*1.8:player.s;const targetX=Math.max(20,Math.min(c.width-60,touchX-20));const targetY=Math.max(30,Math.min(c.height-50,touchY-80));player.x+=(targetX-player.x)*0.12*currentSpeed;player.y+=(targetY-player.y)*0.12*currentSpeed;}

// Forcer le joueur Ã  rester dans les limites du canvas
player.x = Math.max(0, Math.min(c.width - player.w, player.x));
player.y = Math.max(0, Math.min(c.height - player.h, player.y));

// Mode bonus : pas de tir
if(!isBonusLevel&&shooting&&Date.now()-lastShot>(multi?100:200)){
  if(multi){
    // Triple laser : trois larges faisceaux colorÃ©s
    bullets.push(bullet(player.x+2,player.y,'#e74c3c',12));  // Rouge gauche
    bullets.push(bullet(player.x+15,player.y,'#3498db',12)); // Bleu centre
    bullets.push(bullet(player.x+28,player.y,'#f1c40f',12)); // Jaune droite
  }else{
    const bulletColor='#3498db'; // Bleu quand on tire
    bullets.push(bullet(player.x+18,player.y,bulletColor));
  }
  playSound('shoot');
  lastShot=Date.now();
}

// VÃ©rifier l'expiration des power-ups basÃ©s sur le temps (uniquement en jeu)
if(state === 'playing') {
  if(umbrella && umbrellaEndTime > 0 && Date.now() > umbrellaEndTime) umbrella = false;
  if(speed && speedEndTime > 0 && Date.now() > speedEndTime) speed = false;
  if(multi && multiEndTime > 0 && Date.now() > multiEndTime) multi = false;
}

// Spawn selon le mode
if(isBonusLevel){
  // Mode bonus : objets tombent
  if(Math.random()<0.03)bonusItems.push(bonusItem());
  
  // Faire tomber les objets bonus
  bonusItems.forEach((item,i)=>{
    item.y+=item.s;
    item.rotation+=item.rotSpeed;
    if(item.y>c.height){
      bonusItems.splice(i,1);
    }else if(hit(item,player)){
      bonusItems.splice(i,1);
      score+=item.points;
      bonusItemsCollected++;
      playSound('bonus'); // Son joyeux de collecte
      
      // Particules colorÃ©es
      for(let j=0;j<10;j++){
        const p=particle(item.x+item.w/2,item.y+item.h/2);
        p.c=item.color;
        particles.push(p);
      }
      
      // Message de points
      msg(`+${item.points} pts ${item.icon}`);
      
      // VÃ©rifier si objectif atteint
      if(bonusItemsCollected>=bonusItemsTarget){
        playSound('levelup'); // Son de victoire du niveau bonus
        setTimeout(()=>endBonusLevel(),500);
      }
    }
  });
}else{
  // Mode normal : nuages et power-ups
  if(Math.random()<currentLevelConfig.cloudSpawnRate)clouds.push(cloud());
  if(Math.random()<currentLevelConfig.powerUpRate)powerUps.push(powerUp(Math.random()*(c.width-30),-30));
}

bullets.forEach((b,i)=>{b.y-=b.s;if(b.y<0)bullets.splice(i,1);});

clouds.forEach((cl,i)=>{
  cl.y+=cl.s;
  if(cl.shoot&&Date.now()-cl.lastShot>cl.delay){
    rain.push(rainDrop(cl.x+cl.w/2,cl.y+cl.h));
    cl.lastShot=Date.now();
  }
  
  // Si le bouclier arc-en-ciel est actif et que le nuage touche la colombe
  if(umbrella && hitCloud(player, cl)){
    // Son magique de transformation
    playSound('rainbow');
    
    // Transformer le nuage en petit cÅ“ur
    hearts.push({
      x: cl.x + cl.w/2,
      y: cl.y + cl.h/2,
      vx: (Math.random() - 0.5) * 4,
      vy: -3 - Math.random() * 2,
      life: 1,
      size: 15,
      c: '#ff69b4',
      rot: 0,
      rotSpeed: (Math.random() - 0.5) * 0.2
    });
    // Particules arc-en-ciel
    for(let j=0; j<5; j++){
      particles.push({
        x: cl.x + cl.w/2,
        y: cl.y + cl.h/2,
        vx: (Math.random() - 0.5) * 3,
        vy: (Math.random() - 0.5) * 3,
        life: 1,
        c: ['#ff0000','#ff7f00','#ffff00','#00ff00','#0000ff','#4b0082','#9400d3'][Math.floor(Math.random()*7)]
      });
    }
    clouds.splice(i,1);
    score += 50;
    totalScore += 50;
  }
  
  if(cl.y>c.height)clouds.splice(i,1);
});

rain.forEach((r,i)=>{r.y+=r.s;if(r.y>c.height){rain.splice(i,1);}else if(!umbrella&&hit(r,player)){rain.splice(i,1);lives--;playSound('damage');updateStats('totalLivesLost');updateStats('deathsByRain');const rainMsgs=t('rain');msg(rainMsgs[Math.floor(Math.random()*rainMsgs.length)]);if(lives<=0){state='gameOver';setSun('sad');stopMusic();const survivalTime=Date.now()-gameStartTime;saveGameEnd(score,level,cloudsCleared,survivalTime);
// Nouveau systÃ¨me de base de donnÃ©es simplifiÃ©
promptPlayerInfo();
const isNewRecord=updateBestScore(totalScore);
if(isNewRecord){msg('\ud83c\udfc6 NOUVEAU RECORD ! Score: '+totalScore);showPopup('\ud83c\udf89 Nouveau record !\n\nScore: '+totalScore+'\n\nTon score a \u00e9t\u00e9 sauvegard\u00e9.\nClique sur Exporter dans le menu Tr\u00e9sor pour le partager.', '\ud83c\udfc6', 'success');}
msg(t('messages.gameOver'));}else{setSun('neutral');setTimeout(()=>{if(state==='playing')setSun('happy');},2000);}}});

// Gestion de la musique de pluie
if (state === 'playing') {
  if (rain.length > 5) {
    // S'il y a beaucoup de pluie, jouer la musique de pluie
    playRainMusic();
  } else if (rain.length === 0) {
    // S'il n'y a plus de pluie, arrÃªter la musique de pluie
    stopRainMusic();
  }
}

powerUps.forEach((p,i)=>{p.y+=p.s;if(p.y>c.height){powerUps.splice(i,1);}else if(hit(p,player)){powerUps.splice(i,1);playSound('powerup');updateStats('totalPowerUpsCollected');if(p.type==='umbrella'){umbrella=true;const remaining=umbrella&&umbrellaEndTime>Date.now()?umbrellaEndTime-Date.now():0;umbrellaEndTime=Date.now()+remaining+5000;msg(t('powerups.umbrella'));}else if(p.type==='speed'){speed=true;const remaining=speed&&speedEndTime>Date.now()?speedEndTime-Date.now():0;speedEndTime=Date.now()+remaining+4000;msg(t('powerups.speed'));}else if(p.type==='multishot'){multi=true;const remaining=multi&&multiEndTime>Date.now()?multiEndTime-Date.now():0;multiEndTime=Date.now()+remaining+6000;msg(t('powerups.multishot'));}}});

// Collision balles-nuages (itÃ©ration inverse pour Ã©viter les problÃ¨mes de splice)
for(let bi = bullets.length - 1; bi >= 0; bi--){
  const b = bullets[bi];
  let hit = false;
  for(let ci = clouds.length - 1; ci >= 0; ci--){
    const cl = clouds[ci];
    if(hitCloud(b,cl)){
      // Effets visuels
      for(let i=0;i<8;i++)particles.push(particle(cl.x+cl.w/2,cl.y+cl.h/2));
      
      // Suppression sÃ©curisÃ©e
      bullets.splice(bi,1);
      clouds.splice(ci,1);
      
      // Son
      playSound('hit');
      
      // Score et stats
      score+=100;
      totalScore+=100;
      cloudsCleared++;
      cloudsInLevel++;
      cloudKillCount++;
      updateStats('totalHits');
      updateStats('totalShots');
      setSun('happy');
      
      // Mode infini : incrÃ©menter le compteur
      if(isInfiniteMode) {
        infiniteCloudsCleared++;
        
        // Afficher verset tous les 50 nuages (50, 100, 150, etc.)
        if(infiniteCloudsCleared % 50 === 0 && state === 'playing') {
          console.log('\ud83d\udcd6 Affichage verset - Nuages d\u00e9truits:', infiniteCloudsCleared);
          // Arr\u00eater compl\u00e8tement le jeu
          const previousState = state;
          state = 'paused';
          showInfiniteVerse(previousState);
          return; // Sortir de la fonction pour arr\u00eater le traitement
        }
      }
      
      // Faire apparaÃ®tre un power-up aprÃ¨s 10 nuages Ã©liminÃ©s
      if(cloudKillCount >= 10 && fallingPowerUps.length === 0) {
        const types = ['heart', 'rainbow', 'star'];
        const randomType = types[Math.floor(Math.random() * types.length)];
        fallingPowerUps.push(createFallingPowerUp(randomType));
        cloudKillCount = 0;
      }
      
      // Message alÃ©atoire
      const gameplayMsgs=t('gameplay');
      if(Math.random()<0.1)msg(gameplayMsgs[Math.floor(Math.random()*gameplayMsgs.length)]);

      // Sauvegarder la progression tous les 10 nuages
      if(cloudsCleared % 10 === 0){saveProgress(level,score,cloudsCleared);}

      // VÃ©rifier si le niveau est terminÃ© (sauf en mode infini)
      if(!isInfiniteMode && cloudsInLevel>=currentLevelConfig.cloudsToPass){
        level++;
        updateHighestLevel(level); // Sauvegarder la progression
        
        // DÃ©clencher niveau bonus aprÃ¨s les niveaux 3, 7, 10 et 13
        if([3,7,10,13].includes(currentLevelIndex)){
          bonusLevelNumber++;
          setTimeout(()=>startBonusLevel(),1000);
        }else{
          completeLevel();
        }
        
        for(let i=0;i<5;i++)setTimeout(()=>hearts.push(heart()),i*150);
      }else if(cloudsCleared%30===0){
        level++;
        updateHighestLevel(level); // Sauvegarder la progression
        msg(t('messages.levelUp',{level:level}));
        for(let i=0;i<3;i++)setTimeout(()=>hearts.push(heart()),i*150);
      }
      
      hit = true;
      break; // Sortir de la boucle interne aprÃ¨s collision
    }
  }
}

hearts.forEach((h,i)=>{
  h.x+=h.vx;
  h.y+=h.vy;
  h.life-=h.decay || 0.01;
  h.rot+=h.rotSpeed || h.rotS || 0;
  h.vy+=0.015;
  if(h.life<=0)hearts.splice(i,1);
});

particles.forEach((p,i)=>{p.x+=p.vx;p.y+=p.vy;p.life-=p.decay;if(p.life<=0)particles.splice(i,1);});

// Mettre Ã  jour les ondes de choc
shockwaves.forEach((wave,i)=>{
  wave.radius += wave.speed;
  wave.opacity = 1 - (wave.radius / wave.maxRadius);
  if(wave.radius >= wave.maxRadius) shockwaves.splice(i,1);
});

// VÃ©rifier l'expiration des power-ups
const now = Date.now();
if(umbrella && now >= umbrellaEndTime) umbrella = false;
if(speed && now >= speedEndTime) speed = false;
if(multi && now >= multiEndTime) multi = false;

scoreEl.textContent=score;cloudsEl.textContent=cloudsCleared;levelEl.textContent=level;livesEl.textContent=lives;starStockEl.textContent=starCount;
}

function render(){
ctx.clearRect(0,0,c.width,c.height);
if(state==='playing' || state==='levelComplete'){
    // Dessiner la pluie dÃ©corative en arriÃ¨re-plan (niveau 7)
    decorativeRain.forEach(drawDecorativeRain);
    
    // Dessiner les nuages de fond dÃ©coratifs
    backgroundClouds.forEach(drawBackgroundCloud);
    
    // Dessine ensuite tout l'arriÃ¨re-plan du jeu
    clouds.forEach(drawCloud);
    rain.forEach(drawRain);
    powerUps.forEach(drawPowerUp);
    bullets.forEach(drawBullet);
    particles.forEach(drawParticle);
    hearts.forEach(drawHeart);
    
    // Dessiner les power-ups qui tombent
    fallingPowerUps.forEach(drawPowerUp);
    
    // Dessiner les ondes de choc
    shockwaves.forEach(drawShockwave);
    
    // Dessiner les objets bonus
    if(isBonusLevel){
      bonusItems.forEach(drawBonusItem);
    }
    
    // Et la colombe EN DERNIER pour qu'elle soit bien visible devant !
    drawPlayer();
    
    // Afficher la progression
    if(state==='playing'){
      ctx.fillStyle='#2c3e50';
      ctx.font='bold 14px Arial';
      ctx.textAlign='center';
      ctx.shadowColor='rgba(255,255,255,0.8)';
      ctx.shadowBlur=3;
      
      if(isBonusLevel){
        const progress=`ğŸ BONUS - ${bonusItemsCollected}/${bonusItemsTarget} objets`;
        ctx.fillText(progress,c.width/2,c.height-10);
      }else{
        const levelInfo = LEVELS_CONFIG[currentLevelIndex];
        const translatedTitle = t('level_titles.' + levelInfo.id);
        const progress=`${levelInfo.icon} ${translatedTitle} - ${cloudsInLevel}/${currentLevelConfig.cloudsToPass}`;
        ctx.fillText(progress,c.width/2,c.height-10);
      }
      
      ctx.shadowBlur=0;
    }
}
}

function loop(time){const dt=time-lastTime;lastTime=time;update(dt);render();requestAnimationFrame(loop);}

// Fonction pour obtenir les coordonnÃ©es relatives au canvas
function getCanvasCoords(clientX, clientY) {
  const rect = c.getBoundingClientRect();
  const scaleX = c.width / rect.width;
  const scaleY = c.height / rect.height;
  return {
    x: (clientX - rect.left) * scaleX,
    y: (clientY - rect.top) * scaleY
  };
}

c.addEventListener('touchstart',(e)=>{
  e.preventDefault();
  if(state==='gameOver'||state==='victory') {
    restart();
  } else {
    const now = Date.now();
    // DÃ©tecter le double-clic (moins de 300ms entre deux clics)
    if(starCount > 0 && now - lastClickTime < 300) {
      // Consommer une Ã©toile
      starCount--;
      lastStarChangeTime = Date.now(); // Marquer le moment du changement
      
      // CrÃ©er l'onde de choc depuis la colombe
      shockwaves.push(createShockwave(player.x + player.w/2, player.y + player.h/2));
      playSound('shockwave');
      
      // Activer l'onde de choc
      const numClouds = clouds.length;
      for(let j = 0; j < numClouds; j++) {
        const cl = clouds[j];
        for(let k = 0; k < 8; k++) particles.push(particle(cl.x + cl.w/2, cl.y + cl.h/2));
        score += 100;
        totalScore += 100;
        cloudsCleared++;
        cloudsInLevel++;
      }
      clouds = [];
      msg(t('powerups.star') + ` (${starCount} restantes)`);
      lastClickTime = 0;
    } else {
      lastClickTime = now;
      const t=e.touches[0];
      const coords = getCanvasCoords(t.clientX, t.clientY);
      touchX=coords.x;
      touchY=coords.y;
      shooting=true;
    }
  }
});

c.addEventListener('touchmove',(e)=>{
  e.preventDefault();
  if(e.touches[0]){
    const coords = getCanvasCoords(e.touches[0].clientX, e.touches[0].clientY);
    touchX=coords.x;
    touchY=coords.y;
  }
});

c.addEventListener('touchend',(e)=>{
  e.preventDefault();
  shooting=false;
  touchX=null;
  touchY=null;
});

c.addEventListener('mousemove',(e)=>{
  const coords = getCanvasCoords(e.clientX, e.clientY);
  // Limiter la position Ã  l'intÃ©rieur du canvas
  touchX = Math.max(0, Math.min(c.width, coords.x));
  touchY = Math.max(0, Math.min(c.height, coords.y));
});

c.addEventListener('mousedown',(e)=>{
  if(state==='gameOver'||state==='victory') {
    restart();
  } else {
    const now = Date.now();
    // DÃ©tecter le double-clic (moins de 300ms entre deux clics)
    if(starCount > 0 && now - lastClickTime < 300) {
      // Consommer une Ã©toile
      starCount--;
      lastStarChangeTime = Date.now(); // Marquer le moment du changement
      
      // CrÃ©er l'onde de choc depuis la colombe
      shockwaves.push(createShockwave(player.x + player.w/2, player.y + player.h/2));
      playSound('shockwave');
      
      // Activer l'onde de choc
      const numClouds = clouds.length;
      for(let j = 0; j < numClouds; j++) {
        const cl = clouds[j];
        for(let k = 0; k < 8; k++) particles.push(particle(cl.x + cl.w/2, cl.y + cl.h/2));
        score += 100;
        totalScore += 100;
        cloudsCleared++;
        cloudsInLevel++;
      }
      clouds = [];
      msg(t('powerups.star') + ` (${starCount} restantes)`);
      lastClickTime = 0;
    } else {
      lastClickTime = now;
      shooting=true;
      // S'assurer que la position est dans les limites
      const coords = getCanvasCoords(e.clientX, e.clientY);
      touchX = Math.max(0, Math.min(c.width, coords.x));
      touchY = Math.max(0, Math.min(c.height, coords.y));
    }
  }
});

c.addEventListener('mouseup',()=>shooting=false);

c.addEventListener('mouseleave',()=>{
  shooting=false;
  touchX=null;
  touchY=null;
});

startBtn.addEventListener('click',()=>{
  startBtn.classList.add('hidden');
  const motivationEl=document.querySelector('.motivation');
  if(motivationEl){
    motivationEl.classList.add('compact');
    // Masquer complÃ¨tement aprÃ¨s 3 secondes
    setTimeout(()=>{
      motivationEl.style.opacity='0';
      setTimeout(()=>motivationEl.remove(),500);
    },3000);
  }
  
  // DÃ©marrer la musique gospel
  if (musicEnabled) {
    playRandomMusic();
  }
  
  autoHideMenuOnStart();
  initGame();
});

addEventListener('resize',resizeCanvas);

// Charger les sauvegardes au dÃ©marrage de la page
loadGameData();
loadPlayerProfile();

// Si pas de donnÃ©es locales mais connectÃ© au cloud, restaurer depuis Supabase
async function restoreFromCloudIfNeeded() {
  const nickname = localStorage.getItem('dovePlayerNickname');
  const email = localStorage.getItem('dovePlayerEmail');
  
  // VÃ©rifier si connectÃ©
  if (nickname && email) {
    console.log('\ud83d\udce5 V\u00e9rification des donn\u00e9es cloud pour:', nickname);
    
    try {
      // Initialiser Supabase
      if (typeof initSupabaseDove === 'function') {
        await initSupabaseDove();
      }
      
      // Charger les donnÃ©es du cloud
      if (typeof loadDovePlayerData === 'function') {
        const cloudData = await loadDovePlayerData(nickname);
        
        console.log('ğŸ“Š DonnÃ©es cloud reÃ§ues:', cloudData);
        
        if (cloudData.success && cloudData.progress) {
          const progress = cloudData.progress;
          
          console.log('ğŸ“Š Progress dÃ©tails:', {
            highScore: progress.highScore,
            highestLevelReached: progress.highestLevelReached,
            starStock: progress.starStock,
            totalCloudsDestroyed: progress.totalCloudsDestroyed
          });
          
          console.log('ğŸ“Š DonnÃ©es locales actuelles:', {
            highScore: gameData.highScore,
            highestLevelReached: gameData.highestLevelReached,
            starStock: gameData.starStock,
            totalCloudsDestroyed: gameData.totalCloudsDestroyed
          });
          
          // Si le cloud a des donnÃ©es plus rÃ©centes ou si local est vide
          const cloudIsNewer = progress.highScore > gameData.highScore || 
                               progress.highestLevelReached > gameData.highestLevelReached;
          
          const localHasData = gameData.highScore > 0 || gameData.highestLevelReached > 1;
          const cloudIsEmpty = progress.highScore === 0 && progress.highestLevelReached === 1;
          
          if (cloudIsNewer) {
            console.log('\ud83d\udd04 Synchronisation depuis le cloud - Donn\u00e9es plus r\u00e9centes d\u00e9tect\u00e9es');
            
            // Restaurer les donnÃ©es depuis le cloud
            gameData.highScore = progress.highScore || 0;
            gameData.highestLevelReached = progress.highestLevelReached || 1;
            gameData.starStock = progress.starStock || 0;
            gameData.totalCloudsDestroyed = progress.totalCloudsDestroyed || 0;
            gameData.totalGamesPlayed = progress.totalGamesPlayed || 0;
            gameData.stats.totalShots = progress.totalShots || 0;
            gameData.stats.totalHits = progress.totalHits || 0;
            gameData.stats.perfectLevels = progress.perfectLevels || 0;
            
            // Sauvegarder localement
            localStorage.setItem(SAVE_KEY, JSON.stringify(gameData));
            
            console.log('\u2705 Donn\u00e9es restaur\u00e9es depuis le cloud:', progress);
            
            // Mettre \u00e0 jour l'affichage
            score = gameData.highScore;
            level = gameData.highestLevelReached;
            starCount = gameData.starStock;
            
            const scoreEl = document.getElementById('score');
            const levelEl = document.getElementById('level');
            const starsEl = document.getElementById('starStock');
            const cloudsEl = document.getElementById('clouds');
            
            if (scoreEl) scoreEl.textContent = score;
            if (levelEl) levelEl.textContent = level;
            if (starsEl) starsEl.textContent = starCount;
            if (cloudsEl) cloudsEl.textContent = gameData.totalCloudsDestroyed;
            
            return true;
          } else if (cloudIsEmpty && localHasData) {
            console.log('\ud83d\udce4 Cloud vide mais donn\u00e9es locales d\u00e9tect\u00e9es - Envoi vers le cloud...');
            
            // Envoyer les donnÃ©es locales vers le cloud
            try {
              if (typeof syncDovePlayerData === 'function') {
                const syncResult = await syncDovePlayerData(nickname, email, gameData);
                if (syncResult.success) {
                  console.log('\u2705 Donn\u00e9es locales synchronis\u00e9es vers le cloud');
                } else {
                  console.warn('\u26a0\ufe0f \u00c9chec synchronisation locale vers cloud:', syncResult.error);
                }
              }
            } catch (error) {
              console.error('\u274c Erreur envoi vers cloud:', error);
            }
            return false;
          } else {
            console.log('\u2705 Donn\u00e9es locales \u00e0 jour - Pas de synchronisation n\u00e9cessaire');
          }
        } else {
          console.log('\u2139\ufe0f Aucune donn\u00e9e cloud trouv\u00e9e pour ce joueur');
        }
      }
    } catch (error) {
      console.error('\u274c Erreur restauration cloud:', error);
    }
  }
  return false;
}

// ExÃ©cuter la restauration cloud si nÃ©cessaire
restoreFromCloudIfNeeded().then(restored => {
  if (!restored) {
    // Mettre \u00e0 jour l'affichage avec les donn\u00e9es locales
if (gameData.highScore > 0) {
  score = gameData.highScore;
  const scoreEl = document.getElementById('score');
  if (scoreEl) scoreEl.textContent = score;
}

if (gameData.highestLevelReached > 1) {
  level = gameData.highestLevelReached;
  const levelEl = document.getElementById('level');
  if (levelEl) levelEl.textContent = level;
}

if (gameData.starStock > 0) {
  starCount = gameData.starStock;
  const starsEl = document.getElementById('starStock');
  if (starsEl) starsEl.textContent = starCount;
}

// Afficher le total de nuages dÃ©truits (toutes parties confondues)
if (gameData.totalCloudsDestroyed > 0) {
  const cloudsEl = document.getElementById('clouds');
  if (cloudsEl) cloudsEl.textContent = gameData.totalCloudsDestroyed;
}

console.log('\ud83c\udfae Interface mise \u00e0 jour - Score:', score, 'Niveau:', level, '\u2b50 \u00c9toiles:', starCount, '\u2601\ufe0f Nuages:', gameData.totalCloudsDestroyed);
  }
});

// Initialiser la langue au chargement
updateUILanguage();

// ============================================
// ğŸ’ AFFICHAGE DES STATISTIQUES
// ============================================

function showStats() {
  const statsDiv = document.createElement('div');
  statsDiv.id = 'statsDisplay';
  statsDiv.style.cssText = `
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 420px;
    max-height: 85vh;
    background: linear-gradient(135deg, rgba(52,152,219,0.98) 0%, rgba(41,128,185,0.98) 100%);
    color: white;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 10px 50px rgba(0,0,0,0.5);
    z-index: 500;
    overflow-y: auto;
  `;
  
  const formatTime = (seconds) => {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    return hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
  };
  
  const accuracy = gameData.stats.totalShots > 0 
    ? ((gameData.stats.totalHits / gameData.stats.totalShots) * 100).toFixed(1)
    : 0;
  
  // Calculer progression des bonus
  const bonusCompleted = gameData.bonusLevels?.completed?.filter(b => b).length || 0;
  const bonusTotalScore = gameData.bonusLevels?.bestScores?.reduce((a,b) => a+b, 0) || 0;
  
  statsDiv.innerHTML = `
    <button onclick="this.parentElement.remove()" style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.3);color:white;border:none;border-radius:50%;width:35px;height:35px;font-size:20px;cursor:pointer;font-weight:bold;line-height:1;">âœ•</button>
    <h2 style="text-align:center;margin-bottom:20px;font-size:24px;">ğŸ’ Mes TrÃ©sors</h2>
    
    <div style="background:linear-gradient(135deg, rgba(231,76,60,0.2), rgba(241,196,15,0.2));padding:15px;border-radius:10px;margin-bottom:15px;border:2px solid rgba(231,76,60,0.3);">
      <h3 style="margin-top:0;text-align:center;">ğŸ‘¤ Mon Profil</h3>
      <p style="margin:8px 0;text-align:center;"><strong>ğŸ® Surnom:</strong> ${localStorage.getItem('dovePlayerNickname') || playerProfile.nickname || 'Non dÃ©fini'}</p>
      <p style="margin:8px 0;text-align:center;"><strong>ğŸ“§ Email:</strong> ${localStorage.getItem('dovePlayerEmail') || playerProfile.email || 'Non dÃ©fini'}</p>
      <p style="margin:8px 0;text-align:center;"><strong>â˜ï¸ Cloud:</strong> ${localStorage.getItem('dovePlayerNickname') && localStorage.getItem('dovePlayerEmail') ? 'âœ… ConnectÃ©' : 'ğŸ”’ DÃ©connectÃ©'}</p>
      <p style="margin:8px 0;text-align:center;"><strong>ğŸ† Meilleur Score:</strong> ${playerProfile.bestScore.toLocaleString()}</p>
      <p style="margin:8px 0;text-align:center;"><strong>ğŸ¯ Niveau Max:</strong> ${playerProfile.highestLevel}</p>
      ${playerProfile.lastPlayed ? `<p style="margin:8px 0;text-align:center;font-size:12px;opacity:0.8;">DerniÃ¨re partie: ${new Date(playerProfile.lastPlayed).toLocaleDateString('fr-FR')}</p>` : ''}
      <div style="text-align:center;margin-top:12px;">
        <button onclick="document.getElementById('statsDisplay').remove(); showSupabaseSave();" style="
          padding:10px 20px;
          background:linear-gradient(135deg, #667eea, #764ba2);
          color:white;
          border:none;
          border-radius:8px;
          font-size:13px;
          font-weight:bold;
          cursor:pointer;
          box-shadow:0 4px 6px rgba(0,0,0,0.2);
          transition:transform 0.2s;
        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
          ${localStorage.getItem('dovePlayerNickname') && localStorage.getItem('dovePlayerEmail') ? 'â˜ï¸ GÃ©rer ma connexion' : 'â˜ï¸ Se connecter au cloud'}
        </button>
      </div>
    </div>
    
    <!-- Onglets de Conseils de Vie -->
    <div style="margin-bottom:20px;">
      <div style="display:flex;gap:8px;margin-bottom:15px;flex-wrap:wrap;justify-content:center;">
        <button onclick="showLifeTip('faith')" style="padding:8px 15px;background:rgba(46,204,113,0.3);color:white;border:2px solid rgba(46,204,113,0.5);border-radius:8px;cursor:pointer;font-weight:bold;font-size:12px;transition:all 0.2s;" onmouseover="this.style.background='rgba(46,204,113,0.5)'" onmouseout="this.style.background='rgba(46,204,113,0.3)'">âœï¸ Foi</button>
        <button onclick="showLifeTip('courage')" style="padding:8px 15px;background:rgba(241,196,15,0.3);color:white;border:2px solid rgba(241,196,15,0.5);border-radius:8px;cursor:pointer;font-weight:bold;font-size:12px;transition:all 0.2s;" onmouseover="this.style.background='rgba(241,196,15,0.5)'" onmouseout="this.style.background='rgba(241,196,15,0.3)'">ğŸ’ª Courage</button>
        <button onclick="showLifeTip('peace')" style="padding:8px 15px;background:rgba(52,152,219,0.3);color:white;border:2px solid rgba(52,152,219,0.5);border-radius:8px;cursor:pointer;font-weight:bold;font-size:12px;transition:all 0.2s;" onmouseover="this.style.background='rgba(52,152,219,0.5)'" onmouseout="this.style.background='rgba(52,152,219,0.3)'">ğŸ•Šï¸ Paix</button>
        <button onclick="showLifeTip('love')" style="padding:8px 15px;background:rgba(231,76,60,0.3);color:white;border:2px solid rgba(231,76,60,0.5);border-radius:8px;cursor:pointer;font-weight:bold;font-size:12px;transition:all 0.2s;" onmouseover="this.style.background='rgba(231,76,60,0.5)'" onmouseout="this.style.background='rgba(231,76,60,0.3)'">â¤ï¸ Amour</button>
      </div>
      <div id="lifeTipContent" style="background:rgba(255,255,255,0.15);padding:20px;border-radius:10px;min-height:150px;">
        <p style="text-align:center;opacity:0.8;font-style:italic;">Clique sur un onglet pour dÃ©couvrir un conseil de vie</p>
      </div>
    </div>
    
    <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:10px;margin-bottom:15px;">
      <h3 style="margin-top:0;">ğŸ† Mes Records</h3>
      <p style="margin:8px 0;"><strong>Meilleur Score:</strong> ${gameData.highScore.toLocaleString()}</p>
      <p style="margin:8px 0;"><strong>Niveau Maximum:</strong> ${gameData.highestLevelReached}</p>
      <p style="margin:8px 0;"><strong>â­ Stock d'Ã‰toiles:</strong> ${gameData.starStock || 0}</p>
    </div>
    
    ${gameData.lastPlayed ? `
      <p style="text-align:center;opacity:0.8;font-size:12px;margin-bottom:15px;">
        DerniÃ¨re partie: ${new Date(gameData.lastPlayed).toLocaleDateString('fr-FR')}
      </p>
    ` : ''}
    
    <div style="background:linear-gradient(135deg, rgba(52,152,219,0.2), rgba(155,89,182,0.2));padding:15px;border-radius:10px;margin-bottom:20px;border:2px solid rgba(52,152,219,0.3);">
      <h3 style="margin-top:0;text-align:center;">âœ¨ CrÃ©ateur</h3>
      <p style="margin:8px 0;text-align:center;"><strong>ğŸ® Emmanuel Payet</strong></p>
      <p style="margin:8px 0;text-align:center;font-size:13px;opacity:0.9;">DÃ©veloppeur & CrÃ©ateur de jeux inspirÃ©s</p>
      <p style="margin:8px 0;text-align:center;font-size:12px;opacity:0.8;">ğŸ“± Audiomack: <strong>emmanuelpayet888</strong></p>
      <p style="margin:6px 0;text-align:center;font-size:11px;opacity:0.7;">Que ce jeu t'inspire et te fortifie ! ğŸ•Šï¸</p>
      <div style="text-align:center;margin-top:12px;">
        <a href="./emmanuel-artist-module.html" target="_blank" style="
          display:inline-block;
          padding:10px 20px;
          background:linear-gradient(135deg, #3498db, #9b59b6);
          color:white;
          text-decoration:none;
          border-radius:8px;
          font-size:13px;
          font-weight:bold;
          box-shadow:0 4px 6px rgba(0,0,0,0.2);
          transition:transform 0.2s;
        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
          ğŸ¨ DÃ©couvrir l'artiste
        </a>
      </div>
    </div>
    
    <div style="background:linear-gradient(135deg, rgba(231,76,60,0.15), rgba(241,196,15,0.15));padding:18px;border-radius:10px;margin-bottom:20px;border:2px solid rgba(231,76,60,0.3);text-align:center;">
      <h3 style="margin-top:0;color:#e74c3c;">ğŸ’¬ TÃ©moignages d'Espoir</h3>
      <p style="margin:10px 0;font-size:13px;opacity:0.9;">DÃ©couvre des histoires de courage et de guÃ©rison</p>
      <button onclick="document.getElementById('statsDisplay').remove(); showTestimonies();" style="
        padding:12px 24px;
        background:linear-gradient(135deg, #e74c3c, #f39c12);
        color:white;
        border:none;
        border-radius:10px;
        font-size:14px;
        font-weight:bold;
        cursor:pointer;
        box-shadow:0 4px 6px rgba(0,0,0,0.2);
        transition:transform 0.2s;
      " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
        ğŸ’ Lire les tÃ©moignages
      </button>
    </div>
    
    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
      <button onclick="this.parentElement.parentElement.remove()" style="
        padding:12px 24px;
        background:#27ae60;
        color:white;
        border:none;
        border-radius:10px;
        font-size:16px;
        font-weight:bold;
        cursor:pointer;
      ">âœ… Fermer</button>
      
      <button onclick="manualCloudSave()" style="
        padding:12px 24px;
        background:#3498db;
        color:white;
        border:none;
        border-radius:10px;
        font-size:16px;
        font-weight:bold;
        cursor:pointer;
      ">â˜ï¸ Sauvegarder Cloud</button>
      
      <button onclick="exportProfileData()" style="
        padding:12px 24px;
        background:#e74c3c;
        color:white;
        border:none;
        border-radius:10px;
        font-size:16px;
        font-weight:bold;
        cursor:pointer;
      ">ğŸ† Partager mon score</button>
    </div>
  `;
  
  document.getElementById('gameContainer').appendChild(statsDiv);
}

// Sauvegarde manuelle vers le cloud
async function manualCloudSave() {
  const nickname = localStorage.getItem('dovePlayerNickname');
  const email = localStorage.getItem('dovePlayerEmail');
  
  if (!nickname || !email) {
    showPopup('âš ï¸ Non connectÃ© !\n\nConnecte-toi d\'abord via le menu TrÃ©sor.', 'â˜ï¸', 'error');
    return;
  }
  
  // VÃ©rifier qu'on a des donnÃ©es valides Ã  sauvegarder
  const hasValidData = gameData.highScore > 0 || gameData.highestLevelReached > 1;
  if (!hasValidData) {
    showPopup('âš ï¸ Aucune donnÃ©e Ã  sauvegarder\n\nJoue d\'abord pour crÃ©er des donnÃ©es !', 'â˜ï¸', 'warning');
    return;
  }
  
  console.log('ğŸ“¤ Sauvegarde manuelle vers le cloud...');
  showPopup('â³ Sauvegarde en cours...', 'â˜ï¸', 'info');
  
  try {
    // Initialiser Supabase
    if (typeof initSupabaseDove === 'function') {
      await initSupabaseDove();
    }
    
    // Sauvegarder avec syncDovePlayerData
    if (typeof syncDovePlayerData === 'function') {
      const result = await syncDovePlayerData(nickname, email, gameData);
      
      if (result.success) {
        console.log('âœ… Sauvegarde cloud rÃ©ussie');
        showPopup(
          'âœ… Sauvegarde rÃ©ussie !\n\n' +
          `Score: ${gameData.highScore}\n` +
          `Niveau: ${gameData.highestLevelReached}\n` +
          `â­ Ã‰toiles: ${gameData.starStock}\n` +
          `â˜ï¸ Nuages: ${gameData.totalCloudsDestroyed}`,
          'â˜ï¸',
          'success'
        );
      } else {
        console.warn('âš ï¸ Ã‰chec sauvegarde cloud:', result.error);
        showPopup('âŒ Ã‰chec sauvegarde !\n\n' + result.error, 'â˜ï¸', 'error');
      }
    } else {
      throw new Error('Fonction syncDovePlayerData non disponible');
    }
  } catch (error) {
    console.error('âŒ Erreur sauvegarde cloud:', error);
    showPopup('âŒ Erreur sauvegarde !\n\n' + error.message, 'â˜ï¸', 'error');
  }
}

// Sauvegarde automatique dans le cloud aprÃ¨s un nouveau record
async function autoSaveToCloud() {
  const nickname = localStorage.getItem('dovePlayerNickname');
  const email = localStorage.getItem('dovePlayerEmail');
  
  if (!nickname || !email) return;
  
  console.log('ğŸ† Sauvegarde automatique du nouveau record...');
  
  try {
    if (typeof initSupabaseDove === 'function') {
      await initSupabaseDove();
    }
    
    if (typeof syncDovePlayerData === 'function') {
      const result = await syncDovePlayerData(nickname, email, gameData);
      
      if (result.success) {
        console.log('âœ… Record sauvegardÃ© dans le cloud !');
        // Afficher une notification discrÃ¨te
        showMessage('â˜ï¸ Record sauvegardÃ© !', 2000);
      }
    }
  } catch (error) {
    console.warn('âš ï¸ Sauvegarde auto cloud Ã©chouÃ©e:', error);
  }
}

// ============================================
// â˜ï¸ğŸ’¾ SYSTÃˆME DE SAUVEGARDE SIMPLIFIÃ‰
// ============================================

// Afficher le statut de connexion et permettre de se connecter
function showSupabaseSave() {
  const nickname = localStorage.getItem('dovePlayerNickname');
  const email = localStorage.getItem('dovePlayerEmail');
  const isConnected = nickname && email;
  
  const statusDiv = document.createElement('div');
  statusDiv.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.85);
    z-index: 999;
    overflow-y: auto;
    padding: 20px;
    box-sizing: border-box;
    display: flex;
    align-items: center;
    justify-content: center;
  `;
  
  statusDiv.innerHTML = `
    <div style="
      max-width: 500px;
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 30px;
      border-radius: 20px;
      color: white;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      position: relative;
    ">
      <button onclick="this.parentElement.parentElement.remove()" style="
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(0,0,0,0.3);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 24px;
        cursor: pointer;
        font-weight: bold;
        line-height: 1;
        transition: all 0.3s;
      " onmouseover="this.style.background='rgba(231,76,60,0.8)'" onmouseout="this.style.background='rgba(0,0,0,0.3)'">âœ•</button>
      
      <div style="text-align: center; margin-bottom: 25px;">
        <div style="font-size: 60px; margin-bottom: 15px;">${isConnected ? 'âœ…â˜ï¸' : 'ğŸ”’'}</div>
        <h2 style="margin: 0; font-size: 28px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
          ${isConnected ? 'ConnectÃ© au Cloud' : 'Connexion Cloud'}
        </h2>
        <p style="margin: 10px 0 0 0; opacity: 0.9; font-size: 14px;">
          ${isConnected ? `ConnectÃ© en tant que <strong>${nickname}</strong>` : 'Sauvegarde automatique dÃ©sactivÃ©e'}
        </p>
      </div>
      
      <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px; backdrop-filter: blur(10px);">
        <h3 style="margin: 0 0 15px 0; font-size: 18px;">âœ¨ SystÃ¨me de sauvegarde</h3>
        <ul style="margin: 0; padding-left: 20px; line-height: 1.8; font-size: 14px;">
          <li>ğŸ’¾ <strong>Locale</strong> : Automatique Ã  chaque niveau</li>
          <li>â˜ï¸ <strong>Cloud</strong> : ${isConnected ? 'Automatique si connectÃ©' : 'NÃ©cessite connexion'}</li>
          <li>ğŸ”„ <strong>Sync</strong> : Temps rÃ©el avec Supabase</li>
        </ul>
      </div>
      
      ${isConnected ? `
        <div style="background: rgba(46,204,113,0.3); padding: 15px; border-radius: 15px; margin-bottom: 20px; border: 2px solid rgba(46,204,113,0.5); text-align: center;">
          <div style="font-size: 14px;">
            <strong>âœ… Sauvegarde cloud activÃ©e</strong>
            <p style="margin: 10px 0 0 0; opacity: 0.9; font-size: 13px;">
              Ta progression est automatiquement sauvegardÃ©e en ligne<br>
              <strong>Email :</strong> ${email}
            </p>
          </div>
        </div>
        <button onclick="disconnectCloudSave()" style="
          width: 100%;
          padding: 15px 20px;
          background: linear-gradient(135deg, #e74c3c, #c0392b);
          color: white;
          border: none;
          border-radius: 12px;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
          box-shadow: 0 4px 15px rgba(0,0,0,0.2);
          transition: all 0.3s;
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'">
          ğŸšª Se dÃ©connecter
        </button>
      ` : `
        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
          <h3 style="margin: 0 0 15px 0; font-size: 18px;">ğŸ‘¤ Connexion Cloud</h3>
          <div style="margin-bottom: 12px;">
            <label style="display: block; margin-bottom: 5px; font-size: 14px; opacity: 0.9;">Pseudo</label>
            <input type="text" id="cloudNickname" placeholder="Ton pseudo" value="${nickname || ''}" style="
              width: 100%;
              padding: 12px;
              border: none;
              border-radius: 8px;
              font-size: 16px;
              box-sizing: border-box;
              background: rgba(255,255,255,0.9);
              color: #2c3e50;
            " />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 14px; opacity: 0.9;">Email</label>
            <input type="email" id="cloudEmail" placeholder="ton@email.com" style="
              width: 100%;
              padding: 12px;
              border: none;
              border-radius: 8px;
              font-size: 16px;
              box-sizing: border-box;
              background: rgba(255,255,255,0.9);
              color: #2c3e50;
            " />
          </div>
        </div>
        <button onclick="connectCloudSave()" style="
          width: 100%;
          padding: 15px 20px;
          background: linear-gradient(135deg, #2ecc71, #27ae60);
          color: white;
          border: none;
          border-radius: 12px;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
          box-shadow: 0 4px 15px rgba(0,0,0,0.2);
          transition: all 0.3s;
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'">
          â˜ï¸ Se connecter
        </button>
      `}
      
      <div style="text-align: center; margin-top: 20px; opacity: 0.7; font-size: 12px;">
        Powered by Supabase ğŸš€
      </div>
    </div>
  `;
  
  document.getElementById('gameContainer').appendChild(statusDiv);
}

// Connexion au cloud
async function connectCloudSave() {
  const nickname = document.getElementById('cloudNickname').value.trim();
  const email = document.getElementById('cloudEmail').value.trim();
  
  if (!nickname || !email) {
    showPopup('\u274c Merci d\'entrer pseudo ET email !', '\u26a0\ufe0f', 'warning');
    return;
  }
  
  // Valider l'email
  if (!email.includes('@')) {
    showPopup('\u274c Email invalide !', '\ud83d\udce7', 'error');
    return;
  }
  
  try {
    // Sauvegarder les identifiants temporairement
    const tempNickname = nickname;
    const tempEmail = email;
    
    // Initialiser Supabase
    if (typeof initSupabaseDove === 'function') {
      await initSupabaseDove();
    }
    
    // Charger les donnÃ©es cloud pour comparaison
    console.log('ğŸ”„ VÃ©rification des donnÃ©es cloud...');
    if (typeof loadDovePlayerData === 'function') {
      const cloudData = await loadDovePlayerData(tempNickname);
      
      if (cloudData.success && cloudData.progress) {
        const cloudScore = cloudData.progress.highScore || 0;
        const cloudLevel = cloudData.progress.highestLevelReached || 1;
        const localScore = gameData.highScore;
        const localLevel = gameData.highestLevelReached;
        
        const cloudHasData = cloudScore > 0 || cloudLevel > 1;
        const localHasData = localScore > 0 || localLevel > 1;
        const localIsBetter = localScore > cloudScore || localLevel > cloudLevel;
        
        // Si conflit : local et cloud ont tous les deux des donnÃ©es diffÃ©rentes
        if (cloudHasData && localHasData && localIsBetter) {
          const choice = confirm(
            `âš ï¸ Conflit de donnÃ©es dÃ©tectÃ© !\n\n` +
            `â˜ï¸ Cloud: Score ${cloudScore}, Niveau ${cloudLevel}\n` +
            `ğŸ’¾ Local: Score ${localScore}, Niveau ${localLevel}\n\n` +
            `Tes donnÃ©es locales sont meilleures !\n\n` +
            `OK = Garder LOCAL et Ã©craser le cloud\n` +
            `Annuler = Garder CLOUD et Ã©craser le local`
          );
          
          if (choice) {
            // Garder le local, envoyer au cloud
            console.log('âœ… Conservation des donnÃ©es locales');
            localStorage.setItem('dovePlayerNickname', tempNickname);
            localStorage.setItem('dovePlayerEmail', tempEmail);
            await autoSaveToCloud();
            showPopup('âœ… ConnectÃ© !\n\nDonnÃ©es locales sauvegardÃ©es dans le cloud.', 'â˜ï¸', 'success');
          } else {
            // Garder le cloud, Ã©craser le local
            console.log('âœ… Conservation des donnÃ©es cloud');
            localStorage.setItem('dovePlayerNickname', tempNickname);
            localStorage.setItem('dovePlayerEmail', tempEmail);
            await restoreFromCloudIfNeeded();
            showPopup('âœ… ConnectÃ© !\n\nDonnÃ©es cloud restaurÃ©es.', 'â˜ï¸', 'success');
          }
        } else {
          // Pas de conflit : synchronisation automatique
          localStorage.setItem('dovePlayerNickname', tempNickname);
          localStorage.setItem('dovePlayerEmail', tempEmail);
          await restoreFromCloudIfNeeded();
          showPopup('âœ… ConnectÃ© avec succÃ¨s !\n\nTa progression sera automatiquement sauvegardÃ©e en ligne.', 'â˜ï¸', 'success');
        }
      } else {
        // Pas de donnÃ©es cloud, juste se connecter
        localStorage.setItem('dovePlayerNickname', tempNickname);
        localStorage.setItem('dovePlayerEmail', tempEmail);
        await restoreFromCloudIfNeeded();
        showPopup('âœ… ConnectÃ© avec succÃ¨s !\n\nTa progression sera automatiquement sauvegardÃ©e en ligne.', 'â˜ï¸', 'success');
      }
    }
    
    // Fermer la modal
    const modal = document.querySelector('[style*="position: fixed"]');
    if (modal) modal.remove();
  } catch (error) {
    console.error('Erreur connexion cloud:', error);
    showPopup(`âŒ Erreur de connexion:\n${error.message}`, 'âš ï¸', 'error');
  }
}

// DÃ©connexion du cloud
function disconnectCloudSave() {
  if (confirm('ğŸ”’ Se dÃ©connecter de la sauvegarde cloud ?\n\nLa sauvegarde locale continuera de fonctionner.')) {
    localStorage.removeItem('dovePlayerNickname');
    localStorage.removeItem('dovePlayerEmail');
    showPopup('\u2705 D\u00e9connect\u00e9 avec succ\u00e8s !\n\nSauvegarde cloud d\u00e9sactiv\u00e9e.', '\ud83d\udeaa', 'info');
    document.querySelector('[style*="position: fixed"]').remove();
  }
}

// Sauvegarde automatique vers le cloud (si connectÃ©)
async function autoSaveToCloud() {
  const nickname = localStorage.getItem('dovePlayerNickname');
  const email = localStorage.getItem('dovePlayerEmail');
  
  // VÃ©rifier si connectÃ©
  if (!nickname || !email) {
    console.log('â„¹ï¸ Sauvegarde cloud dÃ©sactivÃ©e (pas connectÃ©)');
    return;
  }
  
  try {
    // Initialiser Supabase si nÃ©cessaire
    if (typeof initSupabaseDove === 'function') {
      await initSupabaseDove();
    }
    
    // Sauvegarder avec syncDovePlayerData
    const result = await syncDovePlayerData(nickname, email, gameData);
    
    if (result.success) {
      console.log('âœ… Sauvegarde cloud rÃ©ussie');
    } else {
      console.warn('âš ï¸ Ã‰chec sauvegarde cloud:', result.error);
    }
  } catch (error) {
    console.error('âŒ Erreur sauvegarde cloud:', error);
  }
}

// Raccourci clavier pour afficher les stats (Ctrl+S ou Cmd+S)
document.addEventListener('keydown', (e) => {
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    showStats();
  }
});

// ============================================
// ğŸ’ğŸ“– SYSTÃˆME DE NIVEAUX ET HISTOIRE
// ============================================

// DÃ©finition des chapitres de l'histoire
const STORY_CHAPTERS = {
  fr: [
    {
      id: 1,
      title: "L'Ã‰veil de la Colombe",
      intro: "Dans un monde plongÃ© dans les tÃ©nÃ¨bres, une petite colombe s'Ã©veille. Sa mission : rallumer la lumiÃ¨re de l'espoir.",
      outro: "Les premiers nuages se dissipent. L'espoir renaÃ®t doucement..."
    },
    {
      id: 2,
      title: "La TempÃªte Commence",
      intro: "Les nuages deviennent plus sombres. La pluie menace. Mais ta foi est plus forte.",
      outro: "Tu as traversÃ© la tempÃªte ! La lumiÃ¨re perce les nuages."
    },
    {
      id: 3,
      title: "L'Ascension Divine",
      intro: "Le ciel s'ouvre. Les dÃ©fis s'intensifient. Tes ailes se renforcent Ã  chaque bataille.",
      outro: "Tu t'Ã©lÃ¨ves au-dessus des difficultÃ©s ! Le soleil brille de nouveau."
    },
    {
      id: 4,
      title: "Le Souffle de l'Espoir",
      intro: "Les tÃ©nÃ¨bres rÃ©sistent, mais ton cÅ“ur rayonne. Chaque nuage dissipÃ© est une victoire.",
      outro: "L'espoir se rÃ©pand comme une douce brise. Continue ton vol !"
    },
    {
      id: 5,
      title: "La RÃ©vÃ©lation Finale",
      intro: "Le dernier voile de nuages se dresse devant toi. C'est l'heure de la victoire finale.",
      outro: "VICTOIRE ! Le Psaume 99.1 - La vie est une aventure extraordinaire !"
    }
  ],
  en: [
    {
      id: 1,
      title: "The Dove's Awakening",
      intro: "In a world plunged into darkness, a small dove awakens. Your mission: relight the light of hope.",
      outro: "The first clouds dissipate. Hope is slowly reborn..."
    },
    {
      id: 2,
      title: "The Storm Begins",
      intro: "The clouds grow darker. Rain threatens. But your faith is stronger.",
      outro: "You weathered the storm! Light pierces through the clouds."
    },
    {
      id: 3,
      title: "Divine Ascension",
      intro: "The sky opens. Challenges intensify. Your wings strengthen with each battle.",
      outro: "You rise above difficulties! The sun shines again."
    },
    {
      id: 4,
      title: "The Breath of Hope",
      intro: "Darkness resists, but your heart radiates. Each cloud cleared is a victory.",
      outro: "Hope spreads like a gentle breeze. Continue your flight!"
    },
    {
      id: 5,
      title: "The Final Revelation",
      intro: "The last veil of clouds stands before you. It's time for final victory.",
      outro: "VICTORY! Psalm 99.1 - Life is an extraordinary adventure!"
    }
  ]
  // Ajouter d'autres langues au besoin
};

// Configuration des niveaux
const LEVELS_CONFIG = [
  // Niveau 1: CADET - Premiers Vols (0-100 nuages)
  {
    id: 1,
    title: "CADET - Premiers Vols",
    icon: "ï¿½",
    threshold: 0,
    cloudsToPass: 100,
    message: "Bienvenue dans l'AcadÃ©mie des Cieux ! Tu commences ton entraÃ®nement de pilote. Chaque mission te rapproche de ta destinÃ©e.",
    verse: { text: "De loin, l'Ã‰ternel s'est rÃ©vÃ©lÃ© Ã  moi : Â« Je t'aime d'un amour Ã©ternel ; c'est pourquoi je te maintiens ma bontÃ©.", reference: "JÃ©rÃ©mie 31:3" },
    cloudSpeed: { min: 0.5, max: 1.5 },
    cloudSpawnRate: 0.004,
    shootingClouds: 0.3,
    rainSpeed: { min: 4, max: 6 },
    powerUpRate: 0.0012,
    background: { top: '#87ceeb', bottom: '#b8d8f8' },
    difficulty: 'easy'
  },
  // Niveau 2: AVIATEUR - BaptÃªme du Ciel (101-250 nuages)
  {
    id: 2,
    title: "AVIATEUR - BaptÃªme du Ciel",
    icon: "âœˆï¸",
    threshold: 101,
    cloudsToPass: 150,
    message: "Tes ailes se dÃ©ploient avec assurance ! Tu maÃ®trises les bases du vol et dÃ©couvres la libertÃ© des cieux.",
    verse: { text: "L'Ã‰ternel donne de la force Ã  celui qui est fatiguÃ©, et il augmente la vigueur de celui qui tombe en dÃ©faillance.", reference: "Ã‰saÃ¯e 40:29" },
    cloudSpeed: { min: 0.8, max: 2.0 },
    cloudSpawnRate: 0.006,
    shootingClouds: 0.45,
    rainSpeed: { min: 5, max: 7 },
    powerUpRate: 0.0014,
    background: { top: '#7db8d8', bottom: '#a8c8e8' },
    difficulty: 'easy'
  },
  // Niveau 3: AS DES CIEUX - Virtuose AilÃ© (251-450 nuages)
  {
    id: 3,
    title: "AS DES CIEUX - Virtuose AilÃ©",
    icon: "ï¿½ï¸",
    threshold: 251,
    cloudsToPass: 200,
    message: "Tu danses entre les nuages comme un maÃ®tre ! Tes rÃ©flexes s'aiguisent, ta prÃ©cision devient lÃ©gendaire.",
    verse: { text: "Ceux qui espÃ¨rent en l'Ã‰ternel prennent des ailes comme les aigles", reference: "Ã‰saÃ¯e 40:31" },
    cloudSpeed: { min: 1.0, max: 2.5 },
    cloudSpawnRate: 0.008,
    shootingClouds: 0.6,
    rainSpeed: { min: 6, max: 8 },
    powerUpRate: 0.0016,
    background: { top: '#6a9fc8', bottom: '#98b8d8' },
    difficulty: 'medium'
  },
  // Niveau 4: COMMANDANT - Tacticien CÃ©leste (451-700 nuages)
  {
    id: 4,
    title: "COMMANDANT - Tacticien CÃ©leste",
    icon: "â­",
    threshold: 451,
    cloudsToPass: 250,
    message: "On te confie des missions stratÃ©giques ! Tu commandes le ciel avec sagesse et courage, guidÃ© par la lumiÃ¨re divine.",
    verse: { text: "LÃ  oÃ¹ est l'Esprit, lÃ  est la libertÃ©", reference: "2 Corinthiens 3:17" },
    cloudSpeed: { min: 1.3, max: 2.8 },
    cloudSpawnRate: 0.010,
    shootingClouds: 0.7,
    rainSpeed: { min: 7, max: 9 },
    powerUpRate: 0.0017,
    background: { top: '#5a8fb8', bottom: '#88a8c8' },
    difficulty: 'medium'
  },
  // Niveau 5: VÃ‰TÃ‰RAN - ForgÃ© par les TempÃªtes (701-1000 nuages)
  {
    id: 5,
    title: "VÃ‰TÃ‰RAN - ForgÃ© par les TempÃªtes",
    icon: "ğŸ–ï¸",
    threshold: 701,
    cloudsToPass: 300,
    message: "Tu as traversÃ© mille orages ! Chaque cicatrice raconte une victoire. Tu es une lÃ©gende vivante des cieux.",
    verse: { text: "Je t'ai appelÃ© par ton nom, tu es Ã  moi", reference: "Ã‰saÃ¯e 43:1" },
    cloudSpeed: { min: 1.5, max: 3.2 },
    cloudSpawnRate: 0.012,
    shootingClouds: 0.78,
    rainSpeed: { min: 8, max: 10 },
    powerUpRate: 0.0018,
    background: { top: '#4a7fa8', bottom: '#7898b8' },
    difficulty: 'hard'
  },
  // Niveau 6: LÃ‰GENDE - Mythe IncarnÃ© (1001-1400 nuages)
  {
    id: 6,
    title: "LÃ‰GENDE - Mythe IncarnÃ©",
    icon: "ğŸ†",
    threshold: 1001,
    cloudsToPass: 400,
    message: "Ton nom rÃ©sonne dans tous les cieux ! Les cadets rÃªvent de devenir comme toi. Tu incarnes l'excellence et la grÃ¢ce.",
    verse: { text: "Je peux tout par celui qui me fortifie", reference: "Philippiens 4:13" },
    cloudSpeed: { min: 1.7, max: 3.6 },
    cloudSpawnRate: 0.014,
    shootingClouds: 0.85,
    rainSpeed: { min: 9, max: 11 },
    powerUpRate: 0.0019,
    background: { top: '#3a6f98', bottom: '#6888a8' },
    difficulty: 'hard'
  },
  // Niveau 7: MAÃTRE PILOTE - Symphonie AÃ©rienne (1401-1900 nuages)
  {
    id: 7,
    title: "MAÃTRE PILOTE - Symphonie AÃ©rienne",
    icon: "ğŸ‘‘",
    threshold: 1401,
    cloudsToPass: 500,
    message: "Tu ne voles plus, tu composes une symphonie cÃ©leste ! Chaque mouvement est perfection, chaque mission un chef-d'Å“uvre.",
    verse: { text: "AprÃ¨s la pluie vient le beau temps", reference: "Job 37:11" },
    cloudSpeed: { min: 1.9, max: 4.0 },
    cloudSpawnRate: 0.016,
    shootingClouds: 0.90,
    rainSpeed: { min: 10, max: 12 },
    powerUpRate: 0.0020,
    background: { top: '#2a5f88', bottom: '#587898' },
    difficulty: 'expert'
  },
  // Niveau 8: AILE DU CIEL - Gardien Ã‰ternel (1901+ nuages)
  {
    id: 8,
    title: "AILE DU CIEL - Gardien Ã‰ternel",
    icon: "ï¿½ï¸",
    threshold: 1901,
    cloudsToPass: 999,
    message: "Tu as transcendÃ© la mortalitÃ© ! Gardien cÃ©leste, protecteur des cieux, ton vol est dÃ©sormais Ã©ternel. L'infini t'appartient !",
    verse: { text: "L'amour ne pÃ©rit jamais", reference: "1 Corinthiens 13:8" },
    cloudSpeed: { min: 2.0, max: 4.5 },
    cloudSpawnRate: 0.018,
    shootingClouds: 0.95,
    rainSpeed: { min: 11, max: 13 },
    powerUpRate: 0.0021,
    background: { top: '#1a4f78', bottom: '#486888' },
    difficulty: 'legendary'
  }
];

// Variables globales du systÃ¨me de niveaux
let currentLevelIndex = 0;
let currentLevelConfig = LEVELS_CONFIG[0];
let totalScore = 0;
let cloudsInLevel = 0;
let isInfiniteMode = false; // Mode infini activÃ© aprÃ¨s le niveau 14
let infiniteCloudsCleared = 0; // Compteur de nuages en mode infini

function updateLevelBackground() {
  const bg = currentLevelConfig.background;
  document.getElementById('gameContainer').style.background = 
    `linear-gradient(180deg, ${bg.top} 0%, ${bg.bottom} 100%)`;
}

function startLevel(levelIndex) {
  currentLevelIndex = levelIndex;
  
  // Mode infini : on reste sur le dernier niveau (14)
  if (levelIndex >= LEVELS_CONFIG.length) {
    currentLevelConfig = LEVELS_CONFIG[LEVELS_CONFIG.length - 1];
    isInfiniteMode = true;
  } else {
    currentLevelConfig = LEVELS_CONFIG[levelIndex];
  }
  
  cloudsInLevel = 0;
  
  // Mettre Ã  jour l'arriÃ¨re-plan
  updateLevelBackground();
  
  // RÃ©initialiser les Ã©lÃ©ments du jeu (mais PAS les power-ups actifs)
  bullets = [];
  clouds = [];
  rain = [];
  particles = [];
  powerUps = [];
  hearts = [];
  fallingPowerUps = [];
  cloudKillCount = 0;
  collectedStar = false;
  shockwaves = [];
  // umbrella, speed, multi restent actifs pour le niveau suivant
  
  // Activer la pluie dÃ©corative pour le niveau 7
  if (currentLevelConfig.id === 7) {
    decorativeRain = [];
    for (let i = 0; i < 50; i++) {
      decorativeRain.push(decorativeRainDrop());
    }
  } else {
    decorativeRain = [];
  }
  
  // Mettre Ã  jour le niveau affichÃ© dans l'UI
  level = currentLevelConfig.id;
  
  // Afficher l'Ã©cran d'introduction pour le niveau 1 (index 0)
  if (levelIndex === 0) {
    state = 'levelComplete';
    setTimeout(() => {
      const levelUpDiv = document.createElement('div');
      levelUpDiv.id = 'levelUpScreen';
      levelUpDiv.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(240,242,245,0.98) 0%, rgba(255,255,255,0.95) 100%);
        backdrop-filter: blur(20px);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 400;
        padding: 20px;
        box-sizing: border-box;
        animation: fadeIn 0.5s ease-in;
      `;
      levelUpDiv.innerHTML = `
        <div style="max-width: 550px; text-align: center; background: rgba(255,255,255,0.8); padding: 40px 30px; border-radius: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.1), 0 0 0 1px rgba(255,255,255,0.5) inset; border: 2px solid rgba(255,255,255,0.8);">
          <div style="margin-bottom: 25px;">
            <div style="font-size: 50px; margin-bottom: 15px;">ğŸ•Šï¸</div>
            <h2 style="color: #667eea; font-size: 26px; margin: 0 0 15px 0; font-weight: 800; letter-spacing: 1px;">
              ${t('messages.welcome')}
            </h2>
          </div>
          <div style="display: inline-block; padding: 10px 25px; background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%); border-radius: 25px; margin-bottom: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.15);">
            <h3 style="color: #424242; font-size: 20px; margin: 0; font-weight: 800; letter-spacing: 1.5px; text-shadow: 0 1px 2px rgba(255,255,255,0.5);">
              ${currentLevelConfig.icon} NIVEAU ${currentLevelConfig.id}
            </h3>
          </div>
          <div style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 20px; border-radius: 20px; margin-bottom: 20px;">
            <h4 style="color: #2c3e50; font-size: 18px; margin: 0 0 15px 0; font-weight: 700;">
              ${t('level_titles.' + currentLevelConfig.id)}
            </h4>
            <p style="color: #4a5568; font-size: 14px; line-height: 1.7; margin: 0;">
              ${currentLevelConfig.message}
            </p>
          </div>
          <div style="background: rgba(102,126,234,0.08); padding: 20px; border-radius: 20px; margin-bottom: 25px; border-left: 4px solid #667eea;">
            <p style="color: #2c3e50; font-size: 13px; font-style: italic; margin: 0; line-height: 1.7;">
              Â« ${currentLevelConfig.verse.text} Â»
            </p>
            <p style="color: #667eea; font-size: 12px; margin: 10px 0 0 0; font-weight: 600;">
              â€” ${currentLevelConfig.verse.reference}
            </p>
          </div>
          <button id="continueBtn" style="
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 16px 50px;
            border-radius: 50px;
            color: #ffffff;
            font-size: 17px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(102,126,234,0.4);
            transition: all 0.3s;
            letter-spacing: 1px;
            text-transform: uppercase;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
          " onmouseover="this.style.transform='translateY(-3px) scale(1.02)'; this.style.boxShadow='0 12px 30px rgba(102,126,234,0.5)';"
             onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 8px 25px rgba(102,126,234,0.4)';">
            â–¶ Commencer
          </button>
        </div>
      `;
      document.getElementById('gameContainer').appendChild(levelUpDiv);
      
      // Continuer au clic
      document.getElementById('continueBtn').addEventListener('click', () => {
        levelUpDiv.remove();
        state = 'playing';
        autoHideMenuOnStart();
        setSun('happy');
      });
    }, 500);
  } else {
    state = 'playing';
    autoHideMenuOnStart();
    setSun('happy');
  }
}

function completeLevel() {
  state = 'levelComplete';
  const nextLevelIndex = currentLevelIndex + 1;
  
  if (nextLevelIndex >= LEVELS_CONFIG.length) {
    // VICTOIRE FINALE (991 nuages) !
    state = 'victory';
    msg(t('messages.victory'));
    setTimeout(() => {
      // Afficher un Ã©cran de victoire spÃ©cial
      const victoryDiv = document.createElement('div');
      victoryDiv.id = 'victoryScreen';
      victoryDiv.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(240,242,245,0.98) 0%, rgba(255,255,255,0.95) 100%);
        backdrop-filter: blur(20px);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 500;
        padding: 20px;
        box-sizing: border-box;
        animation: fadeIn 0.5s ease-in;
      `;
      victoryDiv.innerHTML = `
        <div style="max-width: 500px; text-align: center; background: rgba(255,255,255,0.8); padding: 40px 30px; border-radius: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.1), 0 0 0 1px rgba(255,255,255,0.5) inset; border: 2px solid rgba(255,255,255,0.8);">
          <div style="display: inline-block; padding: 12px 30px; background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%); border-radius: 25px; margin-bottom: 25px; box-shadow: 0 8px 20px rgba(0,0,0,0.15);">
            <h1 style="color: #424242; font-size: 32px; margin: 0; font-weight: 800; letter-spacing: 2px; text-shadow: 0 1px 2px rgba(255,255,255,0.5);">
              ğŸ† VICTOIRE ğŸ†
            </h1>
          </div>
          <div style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 20px; border-radius: 20px; margin-bottom: 25px;">
            <p style="color: #2c3e50; font-size: 14px; line-height: 1.8; margin: 0 0 20px 0; font-weight: 500;">
              ${t('messages.victory')}
            </p>
            <div style="display: flex; justify-content: space-around; gap: 15px;">
              <div style="flex: 1; background: rgba(255,255,255,0.7); padding: 15px; border-radius: 15px;">
                <div style="font-size: 28px; color: #667eea; font-weight: bold;">${score}</div>
                <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">ğŸ¯ Score final</div>
              </div>
              <div style="flex: 1; background: rgba(255,255,255,0.7); padding: 15px; border-radius: 15px;">
                <div style="font-size: 28px; color: #667eea; font-weight: bold;">${cloudsCleared}</div>
                <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">â˜ï¸ Nuages</div>
              </div>
            </div>
          </div>
          <button id="victoryBtn" style="
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 16px 50px;
            border-radius: 50px;
            color: white;
            font-size: 17px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(102,126,234,0.4);
            transition: all 0.3s;
            letter-spacing: 1px;
            text-transform: uppercase;
          " onmouseover="this.style.transform='translateY(-3px) scale(1.02)'; this.style.boxShadow='0 12px 30px rgba(102,126,234,0.5)';"
             onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 8px 25px rgba(102,126,234,0.4)';">
            ğŸ® Mode Infini
          </button>
        </div>
      `;
      document.getElementById('gameContainer').appendChild(victoryDiv);
      
      // Continuer en mode infini au clic
      document.getElementById('victoryBtn').addEventListener('click', () => {
        victoryDiv.remove();
        isInfiniteMode = true;
        infiniteCloudsCleared = 0;
        currentLevelIndex = LEVELS_CONFIG.length; // Chapitre 15+
        state = 'playing';
        msg('ğŸ”„ Mode Infini activÃ© ! Versets tous les 50 nuages â˜ï¸');
      });
    }, 2000);
  } else {
    // Passage au niveau suivant
    const nextConfig = LEVELS_CONFIG[nextLevelIndex];
    
    // Afficher le message et le verset du nouveau niveau
    setTimeout(() => {
      const levelUpDiv = document.createElement('div');
      levelUpDiv.id = 'levelUpScreen';
      levelUpDiv.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(240,242,245,0.98) 0%, rgba(255,255,255,0.95) 100%);
        backdrop-filter: blur(20px);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 400;
        padding: 20px;
        box-sizing: border-box;
        animation: fadeIn 0.5s ease-in;
      `;
      levelUpDiv.innerHTML = `
        <div style="max-width: 500px; text-align: center; background: rgba(255,255,255,0.8); padding: 40px 30px; border-radius: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.1), 0 0 0 1px rgba(255,255,255,0.5) inset; border: 2px solid rgba(255,255,255,0.8);">
          <div style="display: inline-block; padding: 10px 25px; background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%); border-radius: 25px; margin-bottom: 25px; box-shadow: 0 8px 20px rgba(0,0,0,0.15);">
            <h2 style="color: #424242; font-size: 22px; margin: 0; font-weight: 800; letter-spacing: 1.5px; text-shadow: 0 1px 2px rgba(255,255,255,0.5);">
              ${nextConfig.icon} NIVEAU ${nextConfig.id}
            </h2>
          </div>
          <div style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 20px; border-radius: 20px; margin-bottom: 20px;">
            <h3 style="color: #2c3e50; font-size: 18px; margin: 0 0 15px 0; font-weight: 700;">
              ${t('level_titles.' + nextConfig.id)}
            </h3>
            <p style="color: #4a5568; font-size: 14px; line-height: 1.7; margin: 0;">
              ${nextConfig.message}
            </p>
          </div>
          <div style="background: rgba(102,126,234,0.08); padding: 20px; border-radius: 20px; margin-bottom: 25px; border-left: 4px solid #667eea;">
            <p style="color: #2c3e50; font-size: 13px; font-style: italic; margin: 0; line-height: 1.7;">
              Â« ${nextConfig.verse.text} Â»
            </p>
            <p style="color: #667eea; font-size: 12px; margin: 10px 0 0 0; font-weight: 600;">
              â€” ${nextConfig.verse.reference}
            </p>
          </div>
          <button id="continueBtn" style="
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 16px 50px;
            border-radius: 50px;
            color: white;
            font-size: 17px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(102,126,234,0.4);
            transition: all 0.3s;
            letter-spacing: 1px;
            text-transform: uppercase;
          " onmouseover="this.style.transform='translateY(-3px) scale(1.02)'; this.style.boxShadow='0 12px 30px rgba(102,126,234,0.5)';"
             onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 8px 25px rgba(102,126,234,0.4)';">
            âœ¨ Suivant
          </button>
        </div>
      `;
      document.getElementById('gameContainer').appendChild(levelUpDiv);
      
      // Attendre le clic du joueur
      document.getElementById('continueBtn').addEventListener('click', () => {
        levelUpDiv.remove();
        playSound('levelup');
        startLevel(nextLevelIndex);
      });
    }, 1000);
  }
}

function showInfiniteVerse() {
  // Utiliser les versets de bible-verses.js
  const randomVerse = getRandomVerse();
  
  // Calculer le numÃ©ro du chapitre infini
  const infiniteChapter = Math.floor(infiniteCloudsCleared / 50);
  
  const verseDiv = document.createElement('div');
  verseDiv.style.cssText = `
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 500px;
    background: linear-gradient(135deg, rgba(155,89,182,0.95) 0%, rgba(142,68,173,0.95) 100%);
    color: white;
    padding: 30px;
    border-radius: 20px;
    text-align: center;
    z-index: 450;
    box-shadow: 0 10px 40px rgba(155,89,182,0.5);
    animation: fadeIn 0.5s ease-in;
  `;
  verseDiv.innerHTML = `
    <div style="max-width: 450px; margin: 0 auto;">
      <h2 style="color: #fff; font-size: 28px; margin-bottom: 20px; text-shadow: 0 0 10px rgba(255,255,255,0.5);">
        ğŸ”„ Chapitre ${15 + infiniteChapter} (Mode Infini)
      </h2>
      <p style="color: #f1c40f; font-size: 20px; margin-bottom: 25px; font-weight: bold;">
        ${infiniteCloudsCleared} nuages dissipÃ©s !
      </p>
      <p style="font-size: 18px; line-height: 1.8; margin-bottom: 20px; font-style: italic;">
        Â« ${randomVerse.text} Â»<br>
        <span style="color: #ecf0f1; margin-top: 10px; display: inline-block;">â€” ${randomVerse.reference}</span>
      </p>
      <button id="verseBtn" style="
        background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
        border: none;
        padding: 12px 40px;
        border-radius: 25px;
        color: #2c3e50;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 5px 15px rgba(241,196,15,0.4);
        transition: all 0.3s;
        margin-top: 15px;
      " onmouseover="this.style.transform='translateY(-2px) scale(1.05)'; this.style.boxShadow='0 7px 20px rgba(241,196,15,0.6)';"
         onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 5px 15px rgba(241,196,15,0.4)';">
        âœ¨ Continuer
      </button>
    </div>
  `;
  document.getElementById('gameContainer').appendChild(verseDiv);
  
  // Jouer un son de rÃ©compense si disponible
  if (typeof playSound === 'function') {
    playSound('powerup');
  }
  
  // Attendre le clic du joueur
  document.getElementById('verseBtn').addEventListener('click', () => {
    verseDiv.remove();
    state = 'playing';
    console.log('âœ… Verset fermÃ© - Reprise du jeu');
  });
}

function initGame() {
  // Restaurer les donnÃ©es sauvegardÃ©es
  if (gameData.highScore > 0) {
    score = gameData.highScore;
  }
  
  // Restaurer le niveau actuel
  level = gameData.highestLevelReached || 1;
  
  // Restaurer les Ã©toiles
  if (gameData.starStock) {
    starCount = gameData.starStock;
  }
  
  // DÃ©marrer au niveau sauvegardÃ© (ou niveau 1 si c'est la premiÃ¨re fois)
  const savedLevelIndex = Math.max(0, (gameData.highestLevelReached || 1) - 1);
  // VÃ©rifier que l'index est valide
  const startLevelIndex = Math.min(savedLevelIndex, LEVELS_CONFIG.length - 1);
  startLevel(startLevelIndex);
  
  // Mettre Ã  jour l'affichage des Ã©lÃ©ments UI
  const scoreEl = document.getElementById('score');
  const levelEl = document.getElementById('level');
  const starsEl = document.getElementById('stars');
  
  if (scoreEl) scoreEl.textContent = score;
  if (levelEl) levelEl.textContent = level;
  if (starsEl) starsEl.textContent = starCount;
  
  console.log('\ud83c\udfae Jeu initialis\u00e9 - Score:', score, 'Niveau:', level, '\u2b50\ufe0f \u00c9toiles:', starCount);
}

// Initialiser le drapeau de langue au chargement
updateLanguageFlag();

requestAnimationFrame(loop);
</script>
</body>
</html>




